<!DOCTYPE html>
<html
  lang="en"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:shiro="http://www.pollix.at/thymeleaf/shiro"
>
  <head>
    <th:block th:include="include :: header('List Exchange Delivery Order')" />
    <th:block th:include="include :: easyui-css" />
    <link th:href="@{/css/jquery.toast.min.css}" rel="stylesheet" />
  </head>
  <style>
    .clickable { cursor: pointer; }
  </style>
  <body class="gray-bg">
    <div
      class="modal fade"
      id="modalSubscriptionForm"
      tabindex="-1"
      role="dialog"
      aria-labelledby="myModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header text-center">
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
            <h3 class="modal-title w-100 font-weight-bold">
              Thay đổi hạn lệnh của container
            </h3>
            
          </div>
          <div class="modal-body mx-3">
            <div class="md-form mb-5">
              <p>Các container đang chọn: <b id="container-details"></b></p>
            </div>
            <br>
            <div class="md-form mb-4 form-group">
              <label data-error="wrong" data-success="right" for="form2">
                Nhập ngày mới <i class="fa fa-calendar prefix grey-text"></i>
              </label>
              
              <input type="text" id="form2" class="time-input form-control validate clickable" />
            </div>
          </div>
          <div class="modal-footer d-flex justify-content-center">
            <button class="btn btn-primary" onclick="submit()">
              Xác nhận
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-sm-12 select-table" style="margin-top: 0px;">
        <!-- Search form -->
        <div class="col-sm-12">
          <form id="formId">
            <div class="select-list">
              <ul>
                <li>
                  <input
                    type="text"
                    name="fromDate"
                    id="fromDate"
                    placeholder="Từ ngày"
                  />
                </li>
                <li>
                  <input
                    type="text"
                    name="toDate"
                    id="toDate"
                    placeholder="Đến ngày"
                  />
                </li>
                <li>
                  <input
                    type="text"
                    name="voyageNo"
                    id="voyageNo"
                    placeholder="Chuyến tàu"
                  />
                </li>
                <li>
                  <input
                    type="text"
                    name="contNo"
                    id="contNo"
                    placeholder="Số Cont"
                  />
                </li>
                <li>
                  <input
                    type="text"
                    name="BlNo"
                    id="blNo"
                    placeholder="Vận đơn/BL No"
                  />
                </li>
                <li>
                  <a
                    class="btn btn-primary btn-rounded btn-sm"
                    onclick="$.operate.search()"
                    id="searchBtn"
                    ><i class="glyphicon glyphicon-search"></i> Tìm Kiếm</a
                  >
                </li>
              </ul>
            </div>
          </form>
        </div>
        <!-- Table toolbar -->
        <div class="col-sm-12 fixed-table-toolbar">
          <div class="bs-bars pull-left" style="margin-bottom: 5px;">
            <div class="btn-group-sm" id="toolbar" role="group">
              <a class="btn btn-success" onclick="$.operate.add()">
                <i class="fa fa-plus"></i> Thêm DO
              </a>
              <a
                class="btn btn-primary single disabled"
                onclick="getSelectedRow();"
                id="itCloseToTheDeadlineeeeeeeeeeeeeeee"
                data-toggle="modal"
                data-target="#modalSubscriptionForm"
              >
                <i class="fa fa-edit"></i> Đổi Hạn Lệnh
              </a>
            </div>
          </div>
          <div
            class="columns columns-right btn-group pull-right"
            style="margin-bottom: 5px;"
          >
            <button
              class="btn btn-default btn-outline"
              type="button"
              name="showSearch"
              title="Tìm kiếm"
            >
              <i class="glyphicon glyphicon-search"></i>
            </button>
            <button
              class="btn btn-default btn-outline"
              type="button"
              name="refresh"
              title="Refresh"
            >
              <i class="glyphicon glyphicon-refresh icon-refresh"></i>
            </button>
          </div>
        </div>
        <!-- /table toolbar -->
        <div class="col-sm-12 table-container">
          <table
            id="dg"
            style="width: 100%; height: 500px;"
            pageList="[20,50,100,150,200]"
          >
            <thead>
              <tr>
                <th data-options="field:'id',checkbox:true"></th>
                <th
                  data-options="field:'carrierCode',halign:'center',resizable:true"
                  width="80"
                >
                  Hãng tàu <br />Carrier
                </th>
                <th
                  data-options="field:'billOfLading',halign:'center',"
                  sortable="true"
                  width="110"
                >
                  Số vận đơn<br />B/L No
                </th>
                <th
                  data-options="field:'containerNumber',halign:'center',"
                  sortable="true"
                  width="110"
                >
                  Số cont<br />Container No
                </th>
                <th
                  data-options="field:'consignee',halign:'center'"
                  width="250"
                >
                  Khách hàng<br />Consignee
                </th>
                <th
                  data-options="field:'expiredDem',halign:'center',align:'right'"
                  sortable="true"
                  width="110"
                >
                  Hạn lệnh<br />Expired Date
                </th>
                <th
                  data-options="field:'emptyContainerDepot',halign:'center'"
                  width="200"
                >
                  Nơi hạ rỗng<br />Empty Depot
                </th>
                <th
                  data-options="field:'detFreeTime',halign:'center',align:'right'"
                  width="80"
                >
                  Ngày miễn<br />DET free
                </th>
                <th data-options="field:'vessel',halign:'center'" width="100">
                  Tên tàu<br />Vessel
                </th>
                <th data-options="field:'voyNo',halign:'center'" width="100">
                  Chuyến tàu<br />Voyage No
                </th>
                <th data-options="field:'status',align:'center'" width="80">
                  Trạng thái
                </th>
              </tr>
            </thead>
          </table>
        </div>
      </div>
    </div>
    <th:block th:include="include :: footer" />
    <th:block th:include="include :: easyui-js" />
    <!-- Jquery toast -->
    <script th:src="@{/js/jquery.toast.min.js}"></script>
    <script type="text/javascript">
    // open add layer iframe
    //**********************************
    var prefix = ctx + "carrier/do";
    $(function() {
      var options = {
        url: prefix + "/list",
        createUrl: prefix + "/add",
      };
      $.table.init(options);
    });
    //**********************************

    load();
    function load() {
        var dg = $("#dg").datagrid({
          url: ctx + "carrier/do/list",
          singleSelection: true,
          clientPaging: false,
          pagination: true,
          rownumbers: true,
          pageSize: 50,
          loader: function (param, success, error) {
            var opts = $(this).datagrid("options");
            if (!opts.url) return false;
            $.ajax({
              type: opts.method,
              url: opts.url,
              data: {
                pageNum: param.page,
                pageSize: param.rows,
                orderByColumn: param.sort,
                isAsc: param.order,
              },
              dataType: "json",
              success: function (data) {
                success(data);
              },
              error: function () {
                error.apply(this, arguments);
              },
            });
          },
        });
    }
      

      //Handle click checkbox event
      $(document).on(
        "click",
        ".datagrid-row, .datagrid-header-check",
        function () {
          var checked = $("input:checkbox:checked").length;
          if (!checked) {
            $("#itCloseToTheDeadlineeeeeeeeeeeeeeee").addClass("disabled");
          } else {
            $("#itCloseToTheDeadlineeeeeeeeeeeeeeee").removeClass("disabled");
          }
        }
      );
      var selectedRow;
      var selectedContainer;

      //Get selected row of table
      function getSelectedRow() {
        selectedRow = $(".datagrid-cell-check input[name='id']:checked")
          .map(function () {
            return this.value;
          })
          .get();
        //var jsson = JSON.stringify(selectedRow);
        $.ajax({
          url: "/carrier/do/getContainer",
          method: "get",
          data: {
            containerId: selectedRow
          },
          success: function(result){
            var text = "[";
            result.forEach(element => {
              text += element + ", ";
            });
            $("#container-details").html(text.substring(0, text.length - 2) + "]");
          }
        })
      }

      //Resolve update action
      function submit() {
        var date = $("#form2").val();
        $.ajax({
          url: "/carrier/do/updateExpire",
          method: 'post',
          data: {
            containerId: selectedRow,
            newDate: date,
          },
          success: function(result){
            $.toast({
              heading: "Thành công",
              text:
                "Khai báo DO thành công ！",
              showHideTransition: "fade",
              icon: "success",
              position: "top-right"
            });
            $("#container-details").html("");
            $('.modal').modal('toggle');
            load();
          }
        })
      }
    </script>
    <script>
      /* 
        var hot;
        var currentPage = 0;
        var prefix = "/carrier/do";
        var dataObj;
        var config;
        document.addEventListener("DOMContentLoaded", function () {
            $(document).ready(function() {
                $.ajax({
                    url: prefix + "/list",
                    method: "POST",
                    data: {
                        page: currentPage,
                    }
                }).done(function(result) {
                    dataObj = result.rows;
                    var example = document.getElementById("example");
                    //loadData
                    // hooks = Handsontable.hooks.getRegistered();
                    // hooks.forEach(function (hook) {
                    // config[hook] = function () {
                    //     if (hook == "afterChange") {
                    //     log_events(hook, arguments);
                    //     }
                    // };
                    // });
                    hot = new Handsontable(example, {
                        data: dataObj,
                        stretchH: 'all',
                        width: '100%',
                        colHeaders: [
                        "ID<br>id",
                        "Mã hãng tàu<br>Carrier",
                        "Số lệnh<br> OrderNumber",
                        "Số vận đơn<br> Bill No",
                        "Số container<br>Container No",
                        "Tên khách hàng<br>Consignee",
                        "Hạn lệnh<br> Valid to date",
                        "Nơi hạ vỏ<br> Empty depot",
                        "Số ngày miễn lưu vỏ<br> DET freetime",
                        "Tên tàu<br>Vessel",
                        "Chuyến<br>Voyage",
                        "Trạng thái<br>DO status",
                        "Ghi chú<br>Note"],
                        filter: "true",
                        //licenseKey: "non-commercial-and-evaluation",
                        columns: [
                        {
                            data: 'id',
                            hidden: true
                        },
                        {
                            data: 'carrierCode',
                            type: 'text',
                            readOnly: true
                        },
                        {
                            data: 'orderNumber',
                            type: 'text',
                            readOnly: true
                        },
                        {
                            data: 'billOfLading',
                            type: 'text',
                            readOnly: true
                        },
                        {
                            data: 'containerNumber',
                            type: 'text',
                            readOnly: true
                        },
                        {
                            data: 'consignee',
                            type: 'text',
                            readOnly: true
                        },
                        {
                            data: 'expired_dem',
                            type: 'date',
                            dateFormat: 'MM/DD/YYYY',
                            
                        },
                        {
                            data: 'emptyContainerDepot',
                            type: 'text',
                            readOnly: true
                        },
                        {
                            data: 'detFreeTime',
                            type: 'numeric',
                            
                        },
                        {
                            data: 'vessel',
                            type: 'numeric',
                            readOnly: true
                        },
                        {
                            data: 'voy_no',
                            type: 'numeric',
                            readOnly: true
                        },
                        {
                            data: 'status',
                            type: 'numeric',
                        },
                        {
                            data: 'remark',
                            type: 'text',
                            readOnly: true
                        }
                        ],
                    });
                    });
                });
            });
            // Next Page
            function nextPage(){
                currentPage++;
                $("#formId").append('<input type="hidden" id="pageSet" name="page" value="'+currentPage+'" /> ');
                var form = $("#formId");
                $.ajax({
                    url: prefix + "/list",
                    method: "POST",
                    data : form.serialize(),
                }).done(function(result) {
                    dataObj = result.rows;
                    console.log(currentPage);
                    hot.loadData(dataObj);
                    if(dataObj == '')
                    {
                        $("#nextPage").attr("disabled", true);
                    }
                    hot.render();
                })
                console.log(dataObj);
                
                if(currentPage > 0)
                {
                    $("#prevPage").attr("disabled", false);
                }
                $( "#pageSet" ).remove();
            }
            if(currentPage == 0)
            {
                $("#prevPage").attr("disabled", true);
            }
            // Prev Page
            function prevPage(){
                currentPage--;
                console.log("page",currentPage)
                if(currentPage == 0)
                {
                    $("#prevPage").attr("disabled", true);
                }else {
                    $("#prevPage").attr("disabled", false);
                }
                $("#formId").append('<input type="hidden" id="pageSet" name="page" value="'+currentPage+'" /> ');
                var form = $("#formId");
                $.ajax({
                    url: prefix + "/list",
                    method: "POST",
                    data : form.serialize(),
                }).done(function(result) {
                    dataObj = result.rows;
                    hot.loadData(dataObj);
                    hot.render();
                })
                if(dataObj != '')
                {
                    $("#nextPage").attr("disabled", false);
                }
                $( "#pageSet" ).remove();
            }

            //Search
            function search(){
                $("#formId").submit(function(e) {
                    $(this).append('<input type="hidden" id="pageSet" name="page" value="'+currentPage+'" /> ');
                    e.preventDefault();
                    var form = $("#formId");
                    $.ajax({
                        url: prefix + "/list",
                        type: "POST",
                        data: form.serialize(),
                        done: function(rs)
                        {
                            dataObj = rs.rows;
                            hot.loadData(dataObj);
                            hot.render();
                        }
                        });
                });
                console.log("sss");
                $( "#pageSet" ).remove();
            }

        
            $("#order_Number").change(function (e){
                searchEven();
            });
            $("#carrier_Code").change(function (e){
                searchEven();
            });
            $("#bill_Of_Lading").change(function (e){
                searchEven();
            });
            $("#container_Number").change(function (e){
                searchEven();
            });
            $("#empty_Container_Depot").change(function (e){
                searchEven();
            });
            $("#det_Free_Time").change(function (e){
                searchEven();
            });
            $("#vessel").change(function (e){
                searchEven();
            });
            $("#voyNo").change(function (e){
                searchEven();
            });
            function searchEven()
            {
                $("#formId").append('<input type="hidden" id="pageSet" name="page" value="'+currentPage+'" /> ');
                    var form = $("#formId");
                    $.ajax({
                    url: prefix + "/list",
                    type: "POST",
                    data: form.serialize(),
                    success: function(rs)
                    {
                        dataObj = rs.rows;
                        hot.loadData(dataObj);
                        hot.render();
                    }
                });
                $( "#pageSet" ).remove();
            }

        //update form
        function update() {
        // Get the data in the cells
        var myTableData = hot.getData();
        // If the last row is empty, remove it before validation
        if (myTableData.length > 1 && hot.isEmptyRow(myTableData.length - 1)) {
          // hot.updateSettings({minSpareRows: 0});

          // Remove the last row if it's empty
          hot.alter(
            "remove_row",
            parseInt(myTableData.length - 1),
            (keepEmptyRows = false)
          );
        }
        var cleanedGridData = [];
        $.each(myTableData, function (rowKey, object) {
          if (!hot.isEmptyRow(rowKey)) {
            cleanedGridData.push(object);
          }
        });
        $.each(cleanedGridData, function (key, object) {
          for (var i = 0; i <= 12; i++) {
            if (object[i] == null) {
              object[i] = null;
            }
          }
        });
        
            var jsonData = JSON.stringify(cleanedGridData);
            console.log(jsonData);
            $.ajax({
                url: "/carrier/do/update",
                method: "post",
                data: {
                equipmentDo: jsonData,
                },
            }).done(function (result) {
                alert("Lưu thành công! ");
                searchEven()
            });
        }
*/
    </script>
  </body>
</html>

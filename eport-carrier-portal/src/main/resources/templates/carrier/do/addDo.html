<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Add new DO</title>
    <link
      th:href="@{/handsontable-6.2.2/dist/handsontable.full.min.css}"
      rel="stylesheet"
      media="screen"
    />
    <link th:href="@{/bootstrap-4.4.1/bootstrap.min.css}" rel="stylesheet" />
  </head>
  <style>
    body {
      padding: 0;
      margin: 0;
      background: #ffffff;
    }

    th,
    td {
      font: 12px sans-serif;
    }

    .handsontable th {
      background: #63aeff;
      color: #fff;
      /* font-weight: 300; */
      text-align: center;
      vertical-align: middle;
      font-size: 1rem;
      line-height: 2;
      padding: 5px 2px !important;
      font-family: inherit;
    }

    .handsontable tbody th {
      height: 32px !important;
    }

    .handsontable thead th.ht__highlight {
      background: #63aeff;
    }

    .handsontable td.above-fifty {
      color: #33691e;
      background: #dcedc8;
    }

    /* .handsontable td.not-date {
      background: #fefefe;
    } */

    .handsontable td.current {
      background-color: #dcedc8;
      color: #000;
    }

    .handsontable .htDimmed {
      background-color: #777 !important;
      color: #fff !important;
    }

    /* Validate fail */
    .handsontable td.htInvalid {
      color: #fff;
    }

    .hot-container {
      overflow: hidden;
    }

    .container {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .footer-add {
      display: flex;
      justify-content: flex-end;
    }

    .red {
      color: red !important;
      text-transform: none;
    }
  </style>
  <body>
    <!-- Toast error -->
    <div
      class="toast alert alert-danger"
      id="toast1"
      role="alert"
      aria-live="polite"
      aria-atomic="true"
      data-delay="3000"
      style="
        position: absolute;
        top: 1rem;
        right: 1rem;
        z-index: 1000;
        background-color: #f8d7da !important;
        border-color: #f5c6cb !important;
      "
    >
      <div
        class="toast-header"
        style="
          color: #721c24;
          background-color: #f8d7da !important;
          border-color: #f5c6cb !important;
        "
      >
        <strong class="mr-auto">Lỗi</strong>
        <button
          type="button"
          class="ml-2 mb-1 close"
          data-dismiss="toast"
          aria-label="Close"
        >
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="toast-body">
        Có lỗi ở trong trang tính, vui lòng kiểm tra dữ liệu.
      </div>
    </div>
    <!-- =================================== -->
    <div
      class="toast alert alert-success"
      role="alert"
      id="toast2"
      aria-live="assertive"
      data-delay="3000"
      aria-atomic="true"
      style="
        position: absolute;
        top: 1rem;
        right: 1rem;
        z-index: 1000;
        background-color: #d4edda !important;
        border-color: #c3e6cb !important;
      "
    >
      <div
        class="toast-header"
        style="
          color: #155724;
          background-color: #d4edda !important;
          border-color: #c3e6cb !important;
        "
      >
        <strong class="mr-auto">Thành công</strong>
        <button
          type="button"
          class="ml-2 mb-1 close"
          data-dismiss="toast"
          aria-label="Close"
        >
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="toast-body">
        Khai báo DO thành công
      </div>
    </div>
    <!-- =================================== -->
    <div class="container">
      <h2 style="text-align: center;">Khai báo Delivery Order</h2>
      <hr />
      <div id="example" class="hot handsontable htColumnHeaders"></div>
      <hr />
      <div class="footer-add">
        <button
          type="button"
          class="btn btn-primary"
          onclick="addAll()"
          style="margin-right: 10px;"
        >
          Xác nhận
        </button>
        <button type="button" class="btn btn-dark" onclick="dismiss()">
          Hủy bỏ
        </button>
      </div>
    </div>
    <!-- Jquery -->
    <script
      th:src="@{/bootstrap-4.4.1/jquery-3.4.1.min.js}"
      integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
      crossorigin="anonymous"
    ></script>
    <!-- Boostrap -->
    <script th:src="@{/bootstrap-4.4.1/bootstrap.min.js}"></script>
    <!-- Handsondtable -->
    <script
      th:src="@{/handsontable-6.2.2/dist/handsontable.full.min.js}"
    ></script>
    <script>
      // Get table element
      $(".toast").toast();
      $("#bsalert").alert();
      var example = document.getElementById("example"),
        hot,
        $hooksList,
        hooks;
      var groupName = null;
      var config;
      // Empty row and format date
      dateValidator = function (value, callback) {
        if (!value || 0 === value.length) {
          callback(false);
        } else {
          if (isGoodDate(value)) {
            callback(true);
          } else {
            callback(false);
          }
        }
      };
      //Empty row
      emptyValidator = function (value, callback) {
        if (!value || 0 === value.length) {
          callback(false);
        } else {
          callback(true);
        }
      };

      config = {
        stretchH: "all",
        height: 500,
        minRows: 100,
        width: "100%",
        minSpareRows: 1,
        rowHeaders: true,
        fillHandle: {
          autoInsertRow: true,
        },
        colHeaders: [
          "Số vận đơn <i class='red'>(*)</i><br>Bill No.",
          "Số container <i class='red'>(*)</i><br> Container No.",
          "Tên khách hàng <i class='red'>(*)</i><br> Consignee",
          "Hạn lệnh <i class='red'>(*)</i><br> Valid to date",
          "Nơi hạ vỏ <br> Empty depot",
          "Số ngày miễn lưu vỏ <br> DET freetime",
          "Tên tàu <br> Vessel",
          "Chuyến <br> Voyage",
          "Ghi chú",
        ],
        filter: "true",
        licenseKey: "non-commercial-and-evaluation",
        columns: [
          {
            validator: emptyValidator,
          },
          {
            validator: emptyValidator,
          },
          {
            validator: emptyValidator,
          },
          {
            type: "date",
            dateFormat: "DD/MM/YYYY",
            correctFormat: true,
            defaultDate: new Date(),
            validator: dateValidator,
          },
          {
            
          },
          {
            type: "numeric",
          },
          {},
          {},
          {}
        ],
      };

      // Load table
      document.addEventListener("DOMContentLoaded", function () {
        hooks = Handsontable.hooks.getRegistered();

        hooks.forEach(function (hook) {
          config[hook] = function () {
            if (hook == "afterChange") {
              log_events(hook, arguments);
            }
          };
        });

        hot = new Handsontable(example, config);
        hot.updateSettings({
          cells: function (row, col) {
            var cellProp = {};
            if (col === 5 && isGoodDate(hot.getDataAtCell(row, col))) {
              //cellProp.className = " above-fifty";
            } else if (col === 5) {
              cellProp.className = " not-date";
            }
            return cellProp;
          },
        });

        function log_events(event, data) {
          var str;
          for (var d = 0; d < data.length; d++) {
            try {
              str = JSON.stringify(data[d]);
            } catch (e) {
              str = data[d].toString(); // JSON.stringify breaks on circular reference to a HTML node
            }

            if (str === void 0) {
              continue;
            }

            if (str != null) {
              var row = str.substring(2, str.indexOf(","));
              // $.ajax({
              //   url: "/carrier/do/getCarrierCode",
              //   method: "get",
              // }).done(function (result) {
              //   hot.setDataAtCell(row, 0, result);
              // });
            }

            break;
          }
        }
      });

      function isGoodDate(dt) {
        var reGoodDate = /^(((0[1-9]|[12]\d|3[01])\/(0[13578]|1[02])\/((19|[2-9]\d)\d{2}))|((0[1-9]|[12]\d|30)\/(0[13456789]|1[012])\/((19|[2-9]\d)\d{2}))|((0[1-9]|1\d|2[0-8])\/02\/((19|[2-9]\d)\d{2}))|(29\/02\/((1[6-9]|[2-9]\d)(0[48]|[2468][048]|[13579][26])|(([1][26]|[2468][048]|[3579][26])00))))$/g;
        return reGoodDate.test(dt);
      }

      function addAll() {
        // Get the data in the cells
        var myTableData = hot.getSourceData();
        // If the last row is empty, remove it before validation
        if (myTableData.length > 1 && hot.isEmptyRow(myTableData.length - 1)) {
          // hot.updateSettings({minSpareRows: 0});

          // Remove the last row if it's empty
          hot.alter(
            "remove_row",
            parseInt(myTableData.length - 1),
            (keepEmptyRows = false)
          );
        }
        var cleanedGridData = [];
        $.each(myTableData, function (rowKey, object) {
          if (!hot.isEmptyRow(rowKey)) {
            cleanedGridData.push(object);
          }
        });
        $.each(cleanedGridData, function (key, object) {
          for (var i = 0; i <= 8; i++) {
            if (object[i] == null) {
              object[i] = null;
            }
          }
        });
        var count = 0;
        var main_key;
        $.each(cleanedGridData, function (key, object) {
          if (
            object[0] == null ||
            object[1] == null ||
            object[2] == null ||
            object[3] == null ||
            !isGoodDate(object[3])
          ) {
            $("#toast1").toast("show");
          } else {
            count++;
          }
          main_key = key;
        });
        main_key++;
        console.log(cleanedGridData);
        if (main_key == count) {
          var jsonData = JSON.stringify(cleanedGridData);
          console.log(jsonData);
          $.ajax({
            url: "/carrier/do/add",
            method: "post",
            data: {
              equipmentDo: jsonData,
            },
          }).done(function (result) {
            $("#toast2").toast("show");
            hot.loadData([]);
            hot.render();
          });
        }
        return;

        console.log(cleanedGridData);
        // Validate the cells and submit the form via ajax or whatever
        hot.validateCells(function (result, obj) {
          if (result == true) {
            var jsonData = JSON.stringify(myTableData);
            console.log(jsonData);
          } else {
            //hotInstance.updateSettings({minSpareRows: 1});
          }
        });
      }
    </script>
  </body>
</html>

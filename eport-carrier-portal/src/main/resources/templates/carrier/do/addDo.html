<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Add new DO</title>
    <link
      th:href="@{/handsontable-6.2.2/dist/handsontable.full.min.css}"
      rel="stylesheet"
      media="screen"
    />
    <link th:href="@{/bootstrap-4.4.1/bootstrap.min.css}" rel="stylesheet" />
  </head>
  <style>
    body {
      padding: 0;
      margin: 0;
      background: #ffffff;
    }

    th,
    td {
      font: 12px sans-serif;
    }

    .handsontable th {
      background: #63aeff;
      color: #fff;
      /* font-weight: 300; */
      text-align: center;
      vertical-align: middle;
      font-size: 1rem;
      line-height: 2;
      padding: 5px 2px !important;
      font-family: inherit;
    }

    .handsontable thead th.ht__highlight {
      background: #63aeff;
    }

    .handsontable td.above-fifty {
      color: #33691e;
      background: #dcedc8;
    }

    /* .handsontable td.below-fifty {
      background: #fefefe;
    } */

    .handsontable td.current {
      background-color: #dcedc8;
      color: #000;
    }

    .handsontable .htDimmed {
      background-color: #777 !important;
      color: #fff !important;
    }

    /* Validate fail */
    .handsontable td.htInvalid {
      color: #fff;
    }

    .hot-container {
      overflow: hidden;
    }

    .container {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .footer-add {
      display: flex;
      justify-content: flex-end;
    }

    .red {
      color: red;
      text-transform: none;
    }
  </style>
  <body>
    <div class="container">
      <h2 style="text-align: center">Khai báo Delivery Order</h2>
      <hr />
      <div id="example" class="hot handsontable htColumnHeaders"></div>
      <hr />
      <div class="footer-add">
        <button type="button" class="btn btn-primary" onclick="addAll()">
          Xác nhận
        </button>
      </div>
    </div>
    <!-- Jquery -->
    <script
      th:src="@{/bootstrap-4.4.1/jquery-3.4.1.min.js}"
      integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
      crossorigin="anonymous"
    ></script>
    <!-- Boostrap -->
    <script th:src="@{/bootstrap-4.4.1/bootstrap.min.js}"></script>
    <!-- Handsondtable -->
    <script
      th:src="@{/handsontable-6.2.2/dist/handsontable.full.min.js}"
    ></script>
    <script>
      // Get table element
      var example = document.getElementById("example"),
        hot;
      // Empty row and format date
      dateValidator = function (value, callback) {
        if (!value || 0 === value.length) {
          callback(false);
        } else {
          if (isGoodDate(value)) {
            callback(true);
          } else {
            callback(false);
          }
        }
      };
      //Empty row
      emptyValidator = function (value, callback) {
        if (!value || 0 === value.length) {
          callback(false);
        } else {
          callback(true);
        }
      };
      // Load table
      document.addEventListener("DOMContentLoaded", function () {
        hot = new Handsontable(example, {
          startRows: 2,
          stretchH: "all",
          width: "100%",
          minSpareCols: 1,
          fillHandle: {
            direction: "vertical",
            autoInsertRow: true,
          },
          colHeaders: [
            "STT",
            "Mã hãng tàu <br> Carrier",
            "Số vận đơn <i class='red'>(*)</i><br>Bill No.",
            "Số container <i class='red'>(*)</i><br> Container No.",
            "Tên khách hàng <i class='red'>(*)</i><br> Consignee",
            "Hạn lệnh <i class='red'>(*)</i><br> Valid to date",
            "Nơi hạ vỏ <br> Empty depot",
            "Số ngày miễn lưu vỏ <br> DET freetime",
            "Tên tàu <br> Vessel",
            "Chuyến <br> Voyage",
            "Ghi chú",
          ],
          filter: "true",
          licenseKey: "non-commercial-and-evaluation",
          columns: [
            {
              readOnly: true,
            },
            {
              readOnly: true,
            },
            {
              validator: emptyValidator,
            },
            {
              validator: emptyValidator,
            },
            {
              validator: emptyValidator,
            },
            {
              type: "date",
              dateFormat: "DD/MM/YYYY",
              correctFormat: true,
              defaultDate: new Date(),
              validator: dateValidator,
            },
            {
              type: "numeric",
            },
            {},
            {},
            {},
            {},
          ],
        });
        var totalRow = hot.countRows();
        for (var i = 1; i <= totalRow; i++) {
          hot.setDataAtCell(i - 1, 0, i);
          hot.setDataAtCell(i - 1, 1, "WHA");
        }

        hot.updateSettings({
          cells: function (row, col) {
            var cellProp = {};
            if (col === 5 && isGoodDate(hot.getDataAtCell(row, col))) {
              //cellProp.className = " above-fifty";
            } else if (col === 5) {
              cellProp.className = " below-fifty";
            }
            return cellProp;
          },
        });
      });

      function isGoodDate(dt) {
        var reGoodDate = /^(((0[1-9]|[12]\d|3[01])\/(0[13578]|1[02])\/((19|[2-9]\d)\d{2}))|((0[1-9]|[12]\d|30)\/(0[13456789]|1[012])\/((19|[2-9]\d)\d{2}))|((0[1-9]|1\d|2[0-8])\/02\/((19|[2-9]\d)\d{2}))|(29\/02\/((1[6-9]|[2-9]\d)(0[48]|[2468][048]|[13579][26])|(([1][26]|[2468][048]|[3579][26])00))))$/g;
        return reGoodDate.test(dt);
      }

      function addAll() {
        // Get the data in the cells
        var myTableData = hot.getData();

        // If the last row is empty, remove it before validation
        if (myTableData.length > 1 && hot.isEmptyRow(myTableData.length - 1)) {
          // hot.updateSettings({minSpareRows: 0});

          // Remove the last row if it's empty
          hot.alter(
            "remove_row",
            parseInt(myTableData.length - 1),
            (keepEmptyRows = false)
          );
        }

        // Validate the cells and submit the form via ajax or whatever
        hot.validateCells(function (result, obj) {
          if (result == true) {
            var jsonData = JSON.stringify(myTableData);

            $.ajax({
              url: "/carrier/do/add",
              method: "post",
              data: {
                equipmentDo: jsonData,
              },
            }).done(function (result) {
              console.log(result);
            });
          } else {
            //hotInstance.updateSettings({minSpareRows: 1});
          }
        });
      }
    </script>
  </body>
</html>

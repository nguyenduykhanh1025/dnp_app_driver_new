<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="vn.com.irtech.api.dao.ShipmentDetailDao">
    <select id="selectShipmentDetailsByBLNo" parameterType="ShipmentDetailEntity" resultType="vn.com.irtech.api.entity.ShipmentDetailEntity">
        SELECT            
                M.CNTR_NO AS containerNo,
                M.SZTP2 AS sztp,
                M.FE AS fe,
                M.PTNR_CODE AS opeCode,
                (SELECT VSL_NM FROM TB_VSL WHERE VSL_CD = M.VSL_CD) AS vslName,
                M.VSL_CD AS vslNm,
                M.BOOKING_NO AS bookingNo,
                M.BL_NO AS blNo,
                M.SEAL_NO1 AS sealNo,
                M.WGT AS wgt,
                M.CONSIGNEE AS consignee,
                M.VGM AS vgm,
                M.CALL_SEQ AS voyNo,
                M.chold_chk AS customStatus,
                M.POD AS dischargePort,
                M.POL AS loadingPort,
                CASE
                    WHEN M.TRANS_TYPE = 'T' THEN 'Truck'
                    WHEN M.TRANS_TYPE = 'V' THEN 'Vessel'
                    WHEN M.TRANS_TYPE = 'C' THEN 'CFS'
                    WHEN M.TRANS_TYPE = 'P' THEN 'Bundle'
                    WHEN M.TRANS_TYPE = 'M' THEN 'Mode change'
                    ELSE M.TRANS_TYPE
                END AS transportType,           
                
                CASE
                    WHEN M.CNTR_STATE = 'R' THEN 'Before Reconcile'
                    WHEN M.CNTR_STATE = 'B' THEN 'After Reconcile'
                    WHEN M.CNTR_STATE = 'M' THEN 'Manifested'
                    WHEN M.CNTR_STATE = 'Y' THEN 'Stacking'
                    WHEN M.CNTR_STATE = 'G' THEN 'In Progress Outgoing'
                    WHEN M.CNTR_STATE = 'O' THEN 'In Progress Incoming'
                    WHEN M.CNTR_STATE = 'P' THEN 'Assigned by Trucker'
                    WHEN M.CNTR_STATE = 'Z' THEN 'Under Shifting'
                    WHEN M.CNTR_STATE = 'D' THEN 'Delivered'
                    WHEN M.CNTR_STATE = 'E' THEN 'Empty Gate Out'
                    ELSE M.CNTR_STATE
                END AS containerStatus
            FROM  TB_INVENTORY M
        WHERE M.BL_NO = #{blNo}
        ORDER BY M.CNTR_NO ASC
    </select>
    
    <select id="selectShipmentDetailByContNo" parameterType="ShipmentDetailEntity" resultType="vn.com.irtech.api.entity.ShipmentDetailEntity">
        SELECT            
                M.CNTR_NO AS containerNo,
                M.SZTP2 AS sztp,
                M.FE AS fe,
                M.PTNR_CODE AS opeCode,
                (SELECT VSL_NM FROM TB_VSL V WHERE V.VSL_CD = M.VSL_CD) AS vslName,
                M.VSL_CD AS vslNm,
                M.BOOKING_NO AS bookingNo,
                M.BL_NO AS blNo,
                M.SEAL_NO1 AS sealNo,
                M.WGT AS wgt,
                M.CONSIGNEE AS consignee,
                M.VGM AS vgm,
                M.CALL_SEQ AS voyNo,
                CASE
                	WHEN M.chold_chk = 'N' then 'R'
                	WHEN M.chold_chk = 'Y' then 'N'
                END AS customStatus,
                M.POD AS dischargePort,
                M.POL AS loadingPort,
                CASE
                    WHEN M.TRANS_TYPE = 'T' THEN 'Truck'
                    WHEN M.TRANS_TYPE = 'V' THEN 'Vessel'
                    WHEN M.TRANS_TYPE = 'C' THEN 'CFS'
                    WHEN M.TRANS_TYPE = 'P' THEN 'Bundle'
                    WHEN M.TRANS_TYPE = 'M' THEN 'Mode change'
                    ELSE M.TRANS_TYPE
                END AS transportType,           
                
                CASE
                    WHEN M.CNTR_STATE = 'R' THEN 'Before Reconcile'
                    WHEN M.CNTR_STATE = 'B' THEN 'After Reconcile'
                    WHEN M.CNTR_STATE = 'M' THEN 'Manifested'
                    WHEN M.CNTR_STATE = 'Y' THEN 'Stacking'
                    WHEN M.CNTR_STATE = 'G' THEN 'In Progress Outgoing'
                    WHEN M.CNTR_STATE = 'O' THEN 'In Progress Incoming'
                    WHEN M.CNTR_STATE = 'P' THEN 'Assigned by Trucker'
                    WHEN M.CNTR_STATE = 'Z' THEN 'Under Shifting'
                    WHEN M.CNTR_STATE = 'D' THEN 'Delivered'
                    WHEN M.CNTR_STATE = 'E' THEN 'Empty Gate Out'
                    ELSE M.CNTR_STATE
                END AS containerStatus
            FROM TB_INVENTORY M
		WHERE CNTR_NO = #{containerNo}
				AND OPR_EXPIRE_DATE IS NULL
				AND JOB_ODR_NO2 IS NULL
				AND IX_CD = 'I'
    </select>
    
    <select id="selectCoordinateOfContainers" parameterType="String" resultType="vn.com.irtech.api.entity.ShipmentDetailEntity">
       SELECT            
           CNTR_NO AS containerNo,
           BL_NO AS blNo,
           BLOCK AS block,
           ROWW AS roww,
           BAY AS bay,
           TIER AS tier
        FROM TB_INVENTORY
        WHERE BL_NO = #{blNo}
        ORDER BY CNTR_NO ASC
    </select>
    
    <select id="selectVesselCodeList" resultType="String">
        SELECT
               VSL_CD AS VSL_CD
       	FROM TB_VSL
	</select>
	
	<select id="selectPODList" parameterType="ShipmentDetailEntity"	resultType="String">
		SELECT 
   			POD AS POD
		FROM TB_VSL_POD
		WHERE VSL_CD = #{vslNm} and CALL_SEQ = #{voyNo} and CALL_YEAR = EXTRACT(YEAR FROM sysdate)
		GROUP BY POD
	</select>
	
	<select id="selectConsigneeList" resultType="String">
		SELECT 
	    	ENG_LNM AS CONSIGNEE
		FROM TB_PTNR 
		WHERE PTNR_TYPE = 'CNS'
	</select>
	
	<select id="selectVoyageNoListByVesselCode" parameterType="String" resultType="String">
		SELECT
	    	CALL_SEQ AS VOYAGE
		FROM TB_BERTHPLAN
		WHERE VSL_CD = #{vesselCode}
	</select>	
	<select id="selectOpeCodeList" resultType="String">
	    SELECT 
        	PTNR_CODE AS PTNR_CODE
	    FROM TB_PTNR
	    WHERE PTNR_TYPE = 'SHP'
	    GROUP BY PTNR_CODE
	</select>
	
	<select id="getGroupNameByTaxCode" parameterType="String" resultType="vn.com.irtech.api.entity.ShipmentEntity">
		SELECT
	    	ENG_LNM as groupName,
	    	ADDR as address
		FROM TB_PTNR
		WHERE REG_NO = #{taxCode} AND ROWNUM = 1
	</select>
	<select id="checkContReservedByContainerNos" parameterType="String" resultType="String">
		SELECT 
			CNTR_NO
		FROM TB_RESERVE
		WHERE CNTR_STATE != 'D' AND CNTR_NO IN 
		<foreach item="containerNo" collection="array" open="(" separator="," close=")">
           	#{containerNo}
       	</foreach>
	</select>
    <select id="getCountContByBlNo" parameterType="String" resultType="Integer">
		SELECT COUNT(*)
		FROM TB_INVENTORY
		WHERE BL_NO = #{blNo}
    </select>
    <select id="getOpeCodeCatosByBlNo" parameterType="String" resultType="vn.com.irtech.api.entity.ShipmentEntity">
    	SELECT PTNR_CODE AS opeCode, COUNT(*) AS containerAmount
    	FROM TB_INVENTORY
    	WHERE BL_NO = #{blNo}
    	GROUP BY PTNR_CODE
    </select>
    <select id="checkCustomStatus" resultType="java.lang.Boolean">
    	SELECT CASE
    				WHEN HOLD_CHK = 'N' THEN 'true'
    				WHEN HOLD_CHK = 'Y' THEN 'false'
    			END AS HOLD_CHK
    	FROM TB_HOLD_STATE
    	WHERE HOLD_TYPE = 'C'
    		AND CNTR_NO = #{containerNo}
    		AND CALL_SEQ = #{voyNo}
    </select>
</mapper>
<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">

<head>
  <th:block th:include="include :: header('List Exchange Delivery Order')" />
  <link th:href="@{/ajax/libs/handsontable/6.2.2/handsontable.full.min.css}" rel="stylesheet" media="screen" />
  <link th:href="@{/ajax/libs/handsontable/6.2.2/manualColumnMove/manualColumnMove.css}" rel="stylesheet"
    media="screen" />
  <link th:href="@{/css/jquery.toast.min.css}" rel="stylesheet" />
  <link th:href="@{/ajax/libs/handsontable/6.2.2/pikaday/pikaday.css}" rel="stylesheet" />
</head>
<style>
  body {
    padding: 0;
    margin: 0;
    background: #ffffff;
  }

  th,
  td {
    font: 12px sans-serif;
  }

  #container.handsontable table {
    width: 100%;
  }

  .handsontable td,
  .handsontable th {
    vertical-align: inherit !important;
  }

  .handsontable th {
    background: F0F0F0;
    color: #222222;
    width: auto;
    /* height: 20px; */
    /* font-weight: 300; */
    text-align: center;
    vertical-align: middle;
    font-size: 14;
    line-height: 2;
    padding: 5px 2px !important;
    font-family: inherit;
  }

  .handsontable tbody th {
    height: 32px !important;
  }

  .handsontable thead th.ht__highlight {
    background: #63aeff;
  }

  .handsontable td.above-fifty {
    color: #33691e;
    background: #dcedc8;
  }

  /* .handsontable td.not-date {
    background: #fefefe;
  } */

  .handsontable td.current {
    background-color: #dcedc8;
    color: #000;
  }

  .handsontable .htDimmed {
    background-color: #fff !important;
    color: #000 !important;
  }

  /* Validate fail */
  .handsontable td.htInvalid {
    color: #fff;
  }

  .hot-container {
    overflow: hidden;
  }

  .container {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }

  .footer-add {
    display: flex;
    justify-content: flex-end;
  }

  .red {
    color: red !important;
    text-transform: none;
  }

  .pagination-div {
    display: flex;
    justify-content: flex-end;
  }

  .container {
    padding-top: 10px;
    padding-right: 0;
    padding-left: 0;
    margin-right: auto;
    margin-left: auto;
  }

  .select-list li p,
  .select-list li label:not(.radio-box) {
    float: left;
    width: 100px;
    margin: 5px 5px 5px 0px;
    text-align: right;
  }

  .btn-primary.disabled,
  .btn-primary.disabled:active,
  .btn-primary.disabled.active,
  .btn-primary[disabled] {
    background-color: dimgrey;
    border-color: dimgrey;
  }

  .left-side {
    width: 220px !important;
  }
</style>

<body class="white-bg full-height-layout">
  <div class="container-div">
    <div class="row" style="height: auto;">
      <div class="col-sm-12 search-collapse">
        <form id="formId">
          <div class="select-list">
            <ul>
              <li>
                <input type="text" id="billOfLading" hidden="true" name="billOfLading" />
              </li>
              <li>
                <input type="text" placeholder="Số cont : Cont Number" name="containerNumber" />
              </li>
              <!-- <li>
                <input type="text" placeholder="Tên khách hàng : Consignee" name="consignee" />
              </li>
              <li>
                <input type="text" placeholder="Nơi hạ vỏ : EmptyDepot" name="emptyContainerDepot" />
              </li>
              <li>
                <input type="text" placeholder="Tên tàu : Vessel" name="vessel" />
              </li>
              <li>
                <input type="text" placeholder="Chuyến tàu : Voyage" name="voyNo" />
              </li>
              <li class="select-time">
                <p>Hạn lệnh：</p>
                <input type="text" class="time-input" id="expiredDem_StartDay" placeholder="Ngày bắt đầu"
                  name="expiredDemStartDay" />
                <span>-</span>
                <input type="text" class="time-input" id="expiredDem_EndDay" placeholder="Ngày kết thúc"
                  name="expiredDemEndDay" />
              </li> -->
              <li>
                <buttom class="btn btn-primary btn-rounded btn-sm" onclick="searchEvent()"><i
                    class="fa fa-search"></i>&nbsp;Tìm kiếm</buttom>
              </li>
              <li>
                <buttom class="btn btn-primary btn-rounded btn-sm" onclick="submitDO()">Làm lệnh</buttom>
              </li>
            </ul>
          </div>
        </form>
      </div>
      <button type="button" onclick="changeStatus()" class="btn btn-primary" style="margin-top: 15px;">Làm lệnh cho toàn
        bộ Container</button>
      <button type="button" onclick="changeDocumnetStatus()" class="btn btn-primary" style="margin-top: 15px;">Xác nhận
        đã lấy DO gốc</button>
      <div class="container col-md-12">
        <div id="example" class="hot handsontable htColumnHeaders htRowHeaders"></div>
        <nav aria-label="Page navigation">
          <div class="paginate" style="display: flex; justify-content: space-between; margin-top: 10px">
            <div class="left-side">
              <button id="prevPage" class="btn btn-xs btn-rounder" onclick='prevPage()'
                style="color:#337ab7; background-color: transparent;"><i class="fa fa-chevron-left"></i></button>
              <p style="display:inline">Trang <input type="number" onchange="showPageOnPageInput()" id="input-page"
                  style="width: 30px; text-align: center;"> đến <span id="total-page"></span></p>
              <button id="nextPage" class="btn btn-xs btn-rounder" onclick='nextPage()'
                style="color:#337ab7; background-color: transparent;"><i class="fa fa-chevron-right"></i></button>
              <button onclick="searchEvent()" class="btn btn-xs btn-rounder"
                style="color:#337ab7; background-color: transparent;"><i class="fa fa-refresh"
                  aria-hidden="true"></i></button>
            </div>
            <div class="right-side">
              <span id="item-on-from"></span> đến <span id="item-on-to"></span> trên tổng <span
                id="item-on-page"></span>
            </div>
          </div>
      </div>
    </div>
    <th:block th:include="include :: footer" />
    <script th:src="@{/js/jquery.toast.min.js}"></script>
    <!-- Jquery toast -->
    <script th:src="@{/ajax/libs/handsontable/6.2.2/handsontable.full.min.js}"></script>
    <script th:src="@{/ajax/libs/handsontable/6.2.2/moment/moment.js}"></script>
    <script th:src="@{/ajax/libs/handsontable/6.2.2/pikaday/pikaday.js}"></script>
    <script type="text/javascript" th:inline="javascript">
      var billOfLading = /*[[${getBillOfLading}]]*/ ;
      billOfLading = billOfLading.substr(1, billOfLading.length - 2);
      $('#billOfLading').val(billOfLading);
      console.log(billOfLading);
    </script>
    <script>
      var hot;
      var currentPage = 0;
      var prefix = "/carrier/admin/do";
      var dataObj;
      var config;
      document.addEventListener("DOMContentLoaded", function () {
        var form = $("#formId");
        $(document).ready(function () {
          $.ajax({
              url: prefix + "/getCountPages",
              method: "POST",
              data: {
                billOfLading: billOfLading
              },
            }).done(function (result) {
              document.getElementById("item-on-page").innerHTML = result
              var pages = result / 15;
              document.getElementById("total-page").innerHTML = Math.ceil(pages)
              $('#input-page').val(currentPage + 1);
              document.getElementById("item-on-from").innerHTML = currentPage + 1
              document.getElementById("item-on-to").innerHTML = (currentPage + 1) * 15
            }),
            $.ajax({
              url: prefix + "/listCont",
              method: "POST",
              data: form.serialize(),
            }).done(function (result) {
              dataObj = result.rows;
              var example = document.getElementById("example");
              hot = new Handsontable(example, {
                data: dataObj,
                stretchH: 'all',
                width: 'auto',
                manualColumnResize: true,
                manualRowResize: true,
                height: 500,
                colHeaders: [
                  
                  "Mã hãng tàu<br>Carrier",
                  "Số vận đơn<br> Bill No",
                  "Số container<br>Container No",
                  "Tên chủ hàng<br>Consignee",
                  "Hạn lệnh<br> Valid to date",
                  "Nơi hạ vỏ<br> Empty depot",
                  "Ngày miễn lưu<br> DET Freetime",
                  "Tên tàu<br>Vessel",
                  "Chuyến<br>Voyage",
                  "Ngày nộp<br>DO date in",
                  "Ghi chú<br>Note",
                  "ID<br>id"
                ],
                filter: true,
                licenseKey: "non-commercial-and-evaluation",
                columns: [
                  {
                    data: 'carrierCode',
                    type: 'text',
                    readOnly: true
                  },
                  {
                    data: 'billOfLading',
                    type: 'text',
                    readOnly: true
                  },
                  {
                    data: 'containerNumber',
                    type: 'text',
                    readOnly: true
                  },
                  {
                    data: 'consignee',
                    type: 'text',
                    readOnly: true
                  },
                  {
                    data: 'expiredDem',
                    type: 'date',
                    dateFormat: 'DD/MM/YYYY',
                    correctFormat: true,
                    readOnly: true

                  },
                  {
                    data: 'emptyContainerDepot',
                    type: 'text',
                    readOnly: true
                  },
                  {
                    data: 'detFreeTime',
                    type: 'numeric',
                    readOnly: true

                  },
                  {
                    data: 'vessel',
                    type: 'text',
                    readOnly: true
                  },
                  {
                    data: 'voyNo',
                    type: 'text',
                    readOnly: true
                  },
                  {
                    data: 'documentReceiptDate',
                    type: 'date',
                    dateFormat: 'MM/DD/YYYY',
                    correctFormat: true,
                    readOnly: true
                  },
                  {
                    data: 'remark',
                    type: 'text',
                    readOnly: true
                  },
                  {
                    data: 'id',
                  }
                ],
                rowHeaders: true,
                autoColumnSize: true,
                columnSorting: {
                  indicator: true
                },
                colWidths: [ 70, 70, 70, 160, 100, 160],
                manualColumnMove: true,
                filters: true
              });
              hot.validateCells();
            });
        });
      });
      // Next Page
      function nextPage() {
        currentPage = currentPage + 1;
        $("#formId").append('<input type="hidden" id="pageSet" name="page" value="' + currentPage + '" /> ');
        var form = $("#formId");
        $.ajax({
          url: prefix + "/listCont",
          method: "POST",
          data: form.serialize(),
        }).done(function (result) {
          dataObj = result.rows;
          hot.loadData(dataObj);
          $('#input-page').val(currentPage + 1);

          document.getElementById("item-on-from").innerHTML = (currentPage) * 15
          document.getElementById("item-on-to").innerHTML = (currentPage) * 15 + 15
          if (dataObj == '') {
            $("#nextPage").attr("disabled", true);
          }
          hot.render();
          hot.validateCells();
        })
        if (currentPage > 0) {
          $("#prevPage").attr("disabled", false);
        }
        $("#pageSet").remove();
      }
      if (currentPage == 0) {
        $("#prevPage").attr("disabled", true)
      }
      // Prev Page
      function prevPage() {
        currentPage = currentPage - 1;
        if (currentPage == 0) {
          $("#prevPage").attr("disabled", true);
        } else {
          $("#prevPage").attr("disabled", false);
        }
        $("#formId").append('<input type="hidden" id="pageSet" name="page" value="' + currentPage + '" /> ');
        var form = $("#formId");
        $.ajax({
          url: prefix + "/listCont",
          method: "POST",
          data: form.serialize(),
        }).done(function (result) {
          dataObj = result.rows;
          hot.loadData(dataObj);
          $('#input-page').val(currentPage + 1);
          hot.render();
          hot.validateCells();
          document.getElementById("item-on-from").innerHTML = (currentPage) * 15
          document.getElementById("item-on-to").innerHTML = (currentPage) * 15 + 15
        })
        if (dataObj != '') {
          $("#nextPage").attr("disabled", false);
        }
        $("#pageSet").remove();
      }

      //Search
      function search() {
        $("#formId").submit(function (e) {
          $(this).append('<input type="hidden" id="pageSet" name="page" value="' + currentPage + '" /> ');
          e.preventDefault();
          var form = $("#formId");
          $.ajax({
            url: prefix + "/listCont",
            type: "POST",
            data: form.serialize(),
            done: function (rs) {
              dataObj = rs.rows;
              hot.loadData(dataObj);
              hot.render();
              hot.validateCells();
            }
          });
        });
        $("#pageSet").remove();
      }

      function searchEvent() {
        $("#formId").append('<input type="hidden" id="pageSet" name="page" value="' + currentPage + '" /> ');
        var form = $("#formId");
        $.ajax({
          url: prefix + "/listCont",
          type: "POST",
          data: form.serialize(),
          success: function (rs) {
            dataObj = rs.rows;
            hot.loadData(dataObj);
            hot.render();
            hot.validateCells();
          }
        });
        $("#pageSet").remove();
        currentPage = 0;
        $('#input-page').val(currentPage + 1);
        $("#prevPage").attr("disabled", true)
      }
      function changeStatus() {
        $.modal.confirm("Bạn có chắc chắn muốn làm lệnh <br> cho tất cả container ?", function () {
          doChangeStatus();
        })
      }

      function changeDocumnetStatus() {
        $.modal.confirm("Bạn có chắc chắn muốn xác nhận <br> đã nhận DO gốc ?", function () {
          doChangeDocumnetStatus();
        })
      }

      function doChangeStatus() {
        $.ajax({
          url: prefix + "/changeStatus",
          method: "post",
          data: {
            billOfLading: billOfLading,
          },
        }).done(function (result) {
          console.log(result);
          $.toast({
            heading: "Thành công",
            text: "Lưu thông tin thành công ！",
            showHideTransition: "fade",
            icon: "success",
            position: "top-right"
          });
          searchEvent()
        });
      }

      function doChangeDocumnetStatus() {
        $.ajax({
          url: prefix + "/changeDocumnetStatus",
          method: "post",
          data: {
            billOfLading: billOfLading,
          },
        }).done(function (result) {
          if (result.code == 500) {
            $.toast({
              heading: "Thất bại",
              text: "Lưu thông tin thành công ！",
              showHideTransition: "fade",
              icon: "success",
              position: "top-right"
            });
          } else {
            $.toast({
              heading: "Thành công",
              text: "Lưu thông tin thành công ！",
              showHideTransition: "fade",
              icon: "success",
              position: "top-right"
            });
          }
          searchEvent()
        });
      }
      //userGetPageNumber
      function showPageOnPageInput() {
        var varPageGo = $('#input-page').val();
        currentPage = parseInt(varPageGo) - 1;
        $("#formId").append('<input type="hidden" id="pageSet" name="page" value="' + varPageGo + '" /> ');
        var form = $("#formId");
        $.ajax({
          url: prefix + "/listCont",
          method: "POST",
          data: form.serialize(),
        }).done(function (result) {
          dataObj = result.rows;
          hot.loadData(dataObj);
          hot.render();
          hot.validateCells();
        })
        $("#pageSet").remove();
      }
      //SubmitDO
      function submitDO()
      {
          $.modal.openDo("Xác nhận làm lệnh", prefix + "/checkStatus/{" + billOfLading + "}","500", "400");

      }
    </script>
</body>

</html>
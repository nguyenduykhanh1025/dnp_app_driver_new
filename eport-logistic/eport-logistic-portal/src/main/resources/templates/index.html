<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="renderer" content="webkit" />
  <title>DNP ePort - Web Portal</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link th:href="@{favicon.ico}" rel="stylesheet" />
  <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet" />
  <link th:href="@{/css/jquery.contextMenu.min.css}" rel="stylesheet" />
  <link th:href="@{/css/font-awesome.min.css}" rel="stylesheet" />
  <link th:href="@{/css/animate.css}" rel="stylesheet" />
  <link th:href="@{/css/style.css}" rel="stylesheet" />
  <link th:href="@{/css/skins.css}" rel="stylesheet" />
  <link th:href="@{/eport/css/eport.css}" rel="stylesheet" />
  <link th:href="@{/css/index.css}" rel="stylesheet" />
</head>

<body class="top-navigation full-height-layout white-bg" style="overflow: hidden;">
  <div id="wrapper">
    <!--Right content-->
    <div id="page-wrapper" class="gray-bg dashbard-1">
      <div class="row border-bottom">
        <nav class="navbar navbar-static-top" role="navigation" style="margin-bottom: 0;">
          <ul class="nav navbar-left welcome-message" style="display: flex">
            <li>
              <a title="ePort CND" class="menuItem" id="main-logo">
                <div style="display: flex; justify-content: space-between; padding-right: 50px">
                  <img th:src="@{/img/logo.png}" width="45px" height="45px" id="logo-img" />
                  <div class="text" style="display: flex; flex-direction: column;">
                    <span class="brand-title">ePORT: Logistic Portal</span>
                    <span style="font-size: 13px;">CẢNG ĐÀ NẴNG</span>
                  </div>
                </div>
              </a>
            </li>
            <li class="dropdown user-menu">
              <a title="Đăng ký làm lệnh" class="menuItem"><i class="fa fa-calendar-check-o"></i>&nbsp; Đăng Ký Làm Lệnh</a>
              <ul class="dropdown-menu">
                <li><a class="menuItem" id="receiveF" th:href="@{/logistic/receive-cont-full}">Nhận Cont Hàng Từ Cảng</a></li>
                <li><a class="menuItem" id="sendE" th:href="@{/logistic/send-cont-empty}">Giao Cont Rỗng Cho Cảng</a></li>
                <li><a class="menuItem" id="receiveE" th:href="@{/logistic/receive-cont-empty}">Nhận Cont Rỗng Từ Cảng</a></li>
                <li><a class="menuItem" id="sendF" th:href="@{/logistic/send-cont-full}">Giao Cont Hàng Cho Cảng</a></li>
                <div style="background-color: #3c8dbc; height: 1px;"></div>
                <li><a class="menuItem" >Đóng Hàng Từ Cont Tại Cảng</a></li>
                <li><a class="menuItem" >Rút Hàng Từ Cont Tại Cảng</a></li>
              </ul>
            </li>
            <li class="dropdown user-menu">
              <a title="Điều hành"  class="menuItem"><i class="fa fa-users"></i>&nbsp; Điều hành</a>
              <ul class="dropdown-menu">
                <li><a class="menuItem" th:href="@{/logistic/assignTruck}">Điều Xe</a></li>
                <li><a class="menuItem" th:href="@{/logistic/transportMonitor/}">Giám Sát</a></li>
                <li><a class="menuItem" th:href="@{/logistic/container/status}">Tình Trạng Container</a></li>
              </ul>
            </li>
            <li class="dropdown user-menu">
              <a title="Quản Lý Đội Xe"  class="menuItem"><i class="fa fa-truck"></i>&nbsp; Quản Lý Đội Xe</a>
              <ul class="dropdown-menu">
                <li><a class="menuItem" th:href="@{/logistic/transport}">Quản lý Tài xế</a></li>
                <li><a class="menuItem" th:href="@{/logistic/logisticTruck}">Quản lý Xe</a></li>
                <li><a class="menuItem" th:href="@{/logistic/truck/history}">Lịch Sử</a></li>
              </ul>
            </li>
            <li class="dropdown user-menu">
              <a title="Báo Cáo"  class="menuItem"><i class="fa fa-signal"></i>&nbsp; Báo Cáo</a>
              <ul class="dropdown-menu">
                <li><a class="menuItem" th:href="@{/logistic/report/container}">Báo Cáo Nâng/Hạ Container</a></li>
                <li><a class="menuItem" th:href="@{/logistic/report/costs}">Báo Cáo Cước Phí</a></li>
              </ul>
            </li>
            <li class="dropdown user-menu">
              <a title="Hỗ trợ dịch vụ"  class="menuItem"><i class="fa fa-users"></i>&nbsp; Hỗ Trợ Dịch Vụ</a>
              <ul class="dropdown-menu">
                <li><a class="menuItem" th:href="@{/logistic/vessel-changing}">Đổi Tàu-Chuyến/Booking</a></li>
                <li><a class="menuItem" th:href="@{/logistic/shifting-cont}">Bốc Container Chỉ Định</a></li>
<!-- /*                <li><a class="menuItem" th:href="@{/logistic/order/extension}">Gia Hạn Lệnh</a></li>
                <li><a class="menuItem" th:href="@{/logistic/shipmentSeparating}">Tách Bill Từ Master Bill</a></li>  */ -->
              </ul>
            </li>
          </ul>
          <ul class="nav navbar-top-links navbar-right welcome-message">
            <!-- <li>
              <a title="Hướng dẫn sử dụng portal" th:href="@{/page/tutorial}" class="menuItem"><i
                  class="fa fa-question-circle"></i>&nbsp;Hướng dẫn</a>
            </li> -->
            <li id="notification">
              <a onclick="openListComment()">
                <i class="fa fa-bell notification-icon"></i>
                <span class="badge">0</span>
              </a>
              <div class="notification-list" id="notification-list">
                <div class="view-all">
                  <h3>Thông Báo</h3>
                  <a onclick="viewAll()" id="loadAll">Xem tất cả</a>
                </div>
                <div class="notifications">
                  <div class="loading">
                    <div class="loader"></div>
                    <div>Đang xử lý</div>
                  </div>
                  <div class="empty-div">Không có thông báo</div>
                </div>
                <div class="see-more"><a onclick="loadMore()" id="loadMore">Xem thêm...</a></div>
              </div>
            </li>
            <li class="dropdown user-menu">
              <a href="javascript:void(0)" class="dropdown-toggle" data-hover="dropdown">
                <span class="hidden-xs">[[${#strings.defaultString(groupName, '-')}]]</span
                  >
                </a>
                <ul class="dropdown-menu">
                  <li class="mt5">
                    <a th:href="@{/logistic/profile}" class="menuItem">
                      <i class="fa fa-user"></i> Hồ sơ</a
                    >
                  </li>
                  <li>
                    <a onclick="resetPwd()">
                      <i class="fa fa-key"></i> Thay đổi mật khẩu</a
                    >
                  </li>
                  <li class="divider"></li>
                  <li>
                    <a th:href="@{logout}">
                      <i class="fa fa-sign-out"></i> Đăng xuất</a
                    >
                  </li>
                </ul>
              </li>
            </ul>
          </nav>
        </div>
        <div class="row content-tabs">
          <button class="roll-nav roll-left tabLeft">
            <i class="fa fa-backward"></i>
          </button>
          <nav class="page-tabs menuTabs">
            <div class="page-tabs-content">
              <a href="javascript:;" class="active menuTab" data-id="/main"
                >Trang Chủ</a
              >
            </div>
          </nav>
          <button class="roll-nav roll-right tabRight">
            <i class="fa fa-forward"></i>
          </button>
          <a href="javascript:void(0);" class="roll-nav roll-right tabReload"
            ><i class="fa fa-refresh"></i>
          </a>
        </div>

        <a id="ax_close_max" class="ax_close_max" href="#" title="Close">
          <i class="fa fa-times-circle-o"></i>
        </a>

        <div class="row mainContent" id="content-main">
          <iframe
            class="eport_iframe"
            name="iframe0"
            width="100%"
            height="100%"
            data-id="/main"
            th:src="@{/main}"
            frameborder="0"
            seamless
          ></iframe>
        </div>
        <div class="footer">
          <div class="pull-right">[[${appName}]] v[[${appVersion}]]</div>
        </div>
      </div>
      <!--右侧部分结束-->
    </div>
    <!-- 全局js -->
    <script th:src="@{/js/jquery.min.js}"></script>
    <script th:src="@{/js/bootstrap.min.js}"></script>
    <script th:src="@{/js/plugins/metisMenu/jquery.metisMenu.js}"></script>
    <script
      th:src="@{/js/plugins/slimscroll/jquery.slimscroll.min.js}"
    ></script>
    <script th:src="@{/js/jquery.contextMenu.min.js}"></script>
    <script th:src="@{/ajax/libs/blockUI/jquery.blockUI.js}"></script>
    <script th:src="@{/ajax/libs/layer/layer.min.js}"></script>
    <script th:src="@{/eport/js/eport.js?v=4.2.0}"></script>
    <script th:src="@{/eport/js/common.js?v=4.2.0}"></script>
    <script th:src="@{/eport/index.js}"></script>
    <script th:src="@{/ajax/libs/fullscreen/jquery.fullscreen.js}"></script>
    <script th:inline="javascript">
      var ctx = [[@{/}]];
      var skin = storage.get("skin");
      var mode = "history";
      var historyPath = storage.get("historyPath");
      var currentPage = 1, pageSize = 5, notiCount = 0, total = 0, currentAmount = 0;

      if($.common.isNotEmpty(skin)){
      	$("body").addClass(skin.split('|')[0]);
      	$("body").addClass(skin.split('|')[1]);
      } else {
      	$("body").addClass([[${sideTheme}]]);
      	$("body").addClass([[${skinName}]]);
      }

      function resetPwd() {
          var url = ctx + 'logistic/profile/resetPwd';
          $.modal.open("Thay đổi mật khẩu", url, '770', '380');
      }

      function switchSkin() {
          layer.open({
      		type : 2,
      		shadeClose : true,
      		title : "Change Theme",
      		area : ["530px", "386px"],
      		content : [ctx + "switchSkin", 'no']
      	})
      }

      function applyPath(url) {
      	$('a[href$="' + decodeURI(url) + '"]').click();
          $('a[href$="' + url + '"]').parent("li").addClass("selected").parents("li :not(.user-panel)").addClass("active").end().parents("ul").addClass("in");
      }

      $(function() {
      	if($.common.equals("history", mode) && window.performance.navigation.type == 1) {
      		var url = storage.get('publicPath');
      	    if ($.common.isNotEmpty(url)) {
      	    	applyPath(url);
      	    }
      	} else {
      		var hash = location.hash;
      	    if ($.common.isNotEmpty(hash)) {
      	        var url = hash.substring(1, hash.length);
      	        applyPath(url);
      	    }
      	}
      });

      function openListComment() {
        if ($('.notification-list').is(':visible')) {
          $('.notification-list').hide();
        } else {
          loadNotification();
        }
      }

      window.addEventListener('click', function(e){   
        if (!document.getElementById('notification-list').contains(e.target) && !document.getElementById('notification').contains(e.target)) {
          $('.notification-list').hide();
        }
      });

      $(window).blur( function(e){
        $('.notification-list').hide();
      });

      function loadNotification() {
        $('#loadMore').removeClass('disabled');
        $('#loadAll').removeClass('disabled');
        $('#loadMore').html('Xem thêm...');
        currentPage = 1;
        currentAmount = 0;
        total = 0;
        $('.notification-list').show();
        $('.loading').css('top', ($('.notifications').height()/2) + 10);
        $('.loading').show();
        $.ajax({
          url: ctx + "logistic/comment/notifications",
          method: "GET",
          data: {
            pageNum: currentPage,
            pageSize: pageSize
          },
          success: function (data) {
            if (data.code == 0) {
              if (data.shipmentComments != null && data.shipmentComments.length > 0) {
                let html = '<div class="loading"><div class="loader"></div><div>Đang xử lý</div></div>' + getNotificationIntoView(data.shipmentComments);
                $('.notifications').html(html);
                currentAmount = data.shipmentComments.length;
                total = data.total;
                if (currentAmount >= total) {
                  $('#loadMore').addClass('disabled');
                  $('#loadMore').html('Hết thông báo');
                  $('#loadAll').addClass('disabled');
                }
              } else {
                $('#loadMore').addClass('disabled');
                $('#loadMore').html('Hết thông báo');
                $('#loadAll').addClass('disabled');
              }
            } else {
              $('#loadMore').addClass('disabled');
              $('#loadMore').html('Hết thông báo');
              $('#loadAll').addClass('disabled');
            }
            $('.loading').hide();
          }
        });
      }

      function loadMore() {
        currentPage++;
        $('.loading').css('top', ($('.notifications').height()/2) + 10);
        $('.loading').show();
        $.ajax({
          url: ctx + "logistic/comment/notifications",
          method: "GET",
          data: {
            pageNum: currentPage,
            pageSize: pageSize
          },
          success: function (data) {
            if (data.code == 0) {
              if (data.shipmentComments != null && data.shipmentComments.length > 0) {
                let html = getNotificationIntoView(data.shipmentComments);
                $('.notifications').append(html);
                currentAmount += data.shipmentComments.length;
                if (currentAmount >= total) {
                  $('#loadMore').addClass('disabled');
                  $('#loadMore').html('Hết thông báo');
                  $('#loadAll').addClass('disabled');
                }
              } else {
                $('#loadMore').addClass('disabled');
                $('#loadMore').html('Hết thông báo');
                $('#loadAll').addClass('disabled');
              }
            }
            $('.loading').hide();
          }
        });
      }

      function getNotificationIntoView (shipmentComments) {
        let html = '';
        shipmentComments.forEach(function (element, index) {
          if (element.seenFlg) {
            html += '<div class="message-box" onclick="goToMessageDetail(' + element.serviceType + ',' + element.shipmentId + ')">';
            html += '<div><i class="fa fa-bell-o bell-icon"></i></div>';
          } else {
            html += '<div class="message-box bg-unseen" onclick="goToMessageDetail(' + element.serviceType + ',' + element.shipmentId + ')">';
            html += '<div><i class="fa fa-bell bell-icon"></i></div>';
          }
          html += '<div class="message-body"><div class="message-title">';
          html += element.topic + '</div><div class="message-content">';
          html += element.content + '</div><div class="message-create-date">';
          let createTime = element.createTime;
          let date = '';
          let time = '';
          if (createTime) {
            date = createTime.substring(8, 10) + "/" + createTime.substring(5, 7) + "/" + createTime.substring(0, 4);
            time = createTime.substring(10, 19);
          }
          html += date + ' at ' + time;
          html += '</div></div></div>';
        });
        return html;
      }

      function goToMessageDetail(serviceType, shipmentId) {
        $('.notification-list').hide();
        if (notiCount > 0) {
          notiCount--;
        }
        $('.badge').text(notiCount);
        let url = '';
        switch (serviceType) {
          case 1:
            url = ctx + 'logistic/receive-cont-full';
            $('#receiveF').attr("href", url + "?sId=" + shipmentId);
            $('#receiveF').trigger("click");
            $('#receiveF').attr("href", url);
            break;
          case 2:
            url = ctx + 'logistic/send-cont-empty';
            $('#sendF').attr("href", url + "?sId=" + shipmentId);
            $('#sendF').trigger("click");
            $('#sendF').attr("href", url);
            break;
          case 3:
            url = ctx + 'logistic/receive-cont-empty';
            $('#receiveE').attr("href", url + "?sId=" + shipmentId);
            $('#receiveE').trigger("click");
            $('#receiveE').attr("href", url);
            break;
          case 4:
            url = ctx + 'logistic/send-cont-full';
            $('#sendF').attr("href", url + "?sId=" + shipmentId);
            $('#sendF').trigger("click");
            $('#sendF').attr("href", url);
            break;
        }
      }

      $(function() {
        $.ajax({
        url: ctx + "logistic/comment/amount",
        method: "GET",
        success: function (data) {
            if (data.code == 0) {
              notiCount = data.shipmentCommentAmount;
              $('.badge').text(notiCount);
            }
          }
        });
      });

      function viewAll() {
        $('.loading').css('top', ($('.notifications').height()/2) + 10);
        $('.loading').show();
        $.ajax({
          url: ctx + "logistic/comment/notification/all",
          method: "GET",
          success: function (data) {
            if (data.code == 0) {
              if (data.shipmentComments != null && data.shipmentComments.length > 0) {
                let html = '<div class="loading"><div class="loader"></div><div>Đang xử lý</div></div>' + getNotificationIntoView(data.shipmentComments);
                $('.notifications').html(html);
                $('#loadMore').addClass('disabled');
                $('#loadAll').addClass('disabled');
                $('#loadMore').html('Hết thông báo');
              }
            }
            $('.loading').hide();
          }
        });
      }
    </script>
  </body>
</html>
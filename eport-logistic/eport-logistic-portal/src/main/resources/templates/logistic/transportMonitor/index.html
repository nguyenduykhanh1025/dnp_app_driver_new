<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <th:block th:include="include :: header('Giám sát')" />
    <th:block th:include="include :: select2-css" />
    <link th:href="@{/css/logistic/monitor/style.css}" rel="stylesheet" />
  </head>
  <body class="bg-white">
    <div class="p-main-div">
      <div class="p-list-items row">
        <div class="c-search-zone col-md-12">
          <div class="input-group">
            <select class="form-control c-search-box">
              <option></option>
            </select>
            <span class="input-group-btn">
              <button class="btn btn-default c-btn-search" type="button"><i class="fa fa-search"></i></button>
            </span>
          </div>
        </div>
        <div id="list">

        </div>
        <!-- <div class="c-item col-md-12" onclick="setCenterMap(16.077450, 108.212149)">
          <div class="col-md-4"><span>Tên tài xế:</span></div>
          <div class="col-md-8"><span id="name"></span></div>
          <div class="col-md-4"><span>Biển số xe đầu kéo:</span></div>
          <div class="col-md-8"><span id="truckNo"></span></div>
          <div class="col-md-4"><span>Container:</span></div>
          <div class="col-md-8"><span id="containerNo"></span></div>
        </div> -->

        <div class="col-md-12 text-center">
          <span class="c-loadmore"><i class="fa fa-angle-double-down" aria-hidden="true"></i>&nbsp;Thêm</span>
        </div>
      </div>
      <div id="c-map"></div>
    </div>
    <th:block th:include="include :: footer" />
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBcB5jZhTfANWzYViExPpf7NeEl_jq0T3Q&libraries=places&&language=vi&callback=initMap" async defer></script>
    <th:block th:include="include :: monitor-view" />
    <th:block th:include="include :: select2-js" />
    <script type="text/javascript">
    const PREFIX = ctx + "logistic/transportMonitor"
      // "use strict";
      var locations = [];
      var map;
      $(document).ready(function () {

        setTimeout(() => {
          $.ajax({
            url: PREFIX + "/list",
            method: "get"
          }).done(function(res){
            if (res.code == 0) {
              locations = res.pickupHistories;
              loadListDriver();
              initMap();
            }
          });
        }, 1000);
        


        





        $("#c-map").height($(window).height() - 70);
        $(".c-search-box").select2({
          placeholder: "Nhập biển số xe",
          allowClear: true,
          minimumInputLength: 2,
          ajax: {
            url: "/logistic/transportMonitor/searchTruck",
            dataType: "json",
            method: "GET",
            data: function (params) {
              return {
                keyWord: params.term,
              };
            },
            processResults: function (data) {
              /* 
              Data return must be
              results = [
                {
                  "id": 1,
                  "text": "label display"
                },
                 {
                  "id": 2,
                  "text": "label display"
                }
              ]
            */
              let results = [
                {
                  id: 1,
                  text: "hello I'm result one",
                },
              ];
              return {
                results: results,
              };
            },
          },
        });
      });
      
      function initMap() {
              map = new google.maps.Map(document.getElementById("c-map"), {
                center: { lat: Number(16.047079), lng: Number(108.20623) },
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                zoom: 13,
              });
              let image = {
                url: "/img/truck32x32.png",
                size: new google.maps.Size(32, 32),
                origin: new google.maps.Point(0, 0),
                anchor: new google.maps.Point(16, 16),
              };

              let shape = {
                coords: [1, 1, 1, 25, 20, 25, 20, 1],
                type: "poly",
              };
              for (let i = 0; i < locations.length; i++) {
                let location = new google.maps.LatLng(locations[i].x, locations[i].y);
                let driverName = locations[i].driver.fullName;
                let mobileNumber = locations[i].driver.mobileNumber;
                let truckNo = locations[i].truckNo;
                let chassisNo = locations[i].chassisNo;
                let contNo = locations[i].containerNo;
                var marker = new google.maps.Marker({
                  position: location,
                  map: map,
                  icon: image,
                  shape: shape,
                  animation: google.maps.Animation.DROP,
                  title: truckNo,
                  html:
                    "    <div>\n" +
                    "		<h2>Thông tin chi tiết</h2>" +
                    '        <table class="table table-striped">\n' +
                    "			<tr>" +
                    "			<td>Tài xế: " +
                    "</td>" +
                    "			<td>" +
                    driverName +
                    "</td></tr>" +
                    "			<tr><td>Biển số đầu kéo: " +
                    "</td>" +
                    "			<td>" +
                    mobileNumber +
                    "</td></tr>" +
                    "			<tr><td>Biển số đầu kéo: " +
                    "</td>" +
                    "			<td>" +
                    truckNo +
                    "</td></tr>" +
                    "			</tr>" +
                    "            <tr>\n" +
                    "                <td>Biển số xe rơ moóc:</td>\n" +
                    "                <td> " +
                    chassisNo +
                      "</td></tr>" +
                    "			<tr><td>Biển số đầu kéo: " +
                    "</td>" +
                    "			<td>" +
                    contNo +
                    " </td></tr>\n" +
                    "        </table>\n" +
                    "    </div>",
                });
                bindMarkerinfo(marker);
              }
            }



      var bindMarkerinfo = function (marker) {
        google.maps.event.addListener(marker, "click", function (point) {
          let infowindow = new google.maps.InfoWindow();
          infowindow.setContent(marker.html);
          infowindow.open(map, marker);
        });
      };
      function setCenterMap(lat, lng) {
        let location = new google.maps.LatLng(lat, lng);
        map.setZoom(16);
        map.panTo(location);
      }

      function loadListDriver() {
        let str = '';
        for (let i=0; i<locations.length; i++) {
          str += '<div class="c-item col-md-12" onclick="setCenterMap('+ locations[i].x +', '+ locations[i].y +')">';
          str += '<div class="col-md-4"><span>Tên tài xế:</span></div>';
          str += '<div class="col-md-8"><span>'+ locations[i].driver.fullName +'</span></div>';
          str += '<div class="col-md-4"><span>Biển số xe đầu kéo:</span></div>';
          str += '<div class="col-md-8"><span>'+ locations[i].truckNo +'</span></div>';
          str += '</div>';
        }
        $('#list').html(str);
      }
    </script>
  </body>
</html>

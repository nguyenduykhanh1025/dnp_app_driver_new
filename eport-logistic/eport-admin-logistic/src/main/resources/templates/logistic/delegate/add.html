<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" >
<head>
    <th:block th:include="include :: header('Add Delegate')" />
    <th:block th:include="include :: datetimepicker-css" />
</head>
<body class="white-bg">
    <div class="wrapper wrapper-content animated fadeInRight ibox-content">
        <form class="form-horizontal m" id="form-delegate-add">
            <div class="form-group">    
                <div class="col-sm-8">
                    <input name="logisticGroupId" id="logisticGroupId" class="form-control" type="hidden" >
                </div>
            </div>
            <div class="form-group">    
                <label class="col-sm-3 control-label is-required">MST Ủy Quyền：</label>
                <div class="col-sm-8">
                    <input name="delegateTaxcode" class="form-control" />
                </div>
            </div>
            <div class="form-group">    
                <label class="col-sm-3 control-label is-required">Tênn Cty Được Ủy Quyền</label>
                <div class="col-sm-8">
                    <input name="delegateCompany" class="form-control" onfocus="removeGroupError()" type="text" />
                </div>
            </div>
            <div class="form-group">    
                <label class="col-sm-3 control-label">Hiệu lực từ ngày：</label>
                <div class="col-sm-8">
                    <div class="input-group date">
                        <input name="validFrom" class="form-control" type="text"  />
                        <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                    </div>
                </div>
            </div>
            <div class="form-group">    
                <label class="col-sm-3 control-label">Đến ngày: </label>
                <div class="col-sm-8">
                    <div class="input-group date">
                        <input name="validUntil" class="form-control" type="text"  />
                        <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label">Loại ủy quyền：</label>
                <div class="col-sm-3" style="display: relative;">
                  <select class="form-control" id="delegateType">
                    <option th:each="delegateType, iterator : ${delegateTypes}" th:value=${delegateType.dictValue}
                      th:text=${delegateType.dictLabel}>
                    </option>
                  </select>
                </div>
                <div class="col-sm-2" style="margin-left: 20px; margin-top: 3px;">
                  <button id="addDelegatedBtn" class="btn btn-sm btn-success">Thêm Ủy Quyền</button>
                </div>
              </div>
        </form>
    </div>
    <th:block th:include="include :: footer" />
    <th:block th:include="include :: datetimepicker-js" />
    <script type="text/javascript" th:inline="javascript">
      var logisticId = /*[[${logisticId}]]*/ ;
      </script>
    <script th:inline="javascript">
        var prefix = ctx + "logistic/delegate"
        delegatedLogistic = new Object();
        $("#logisticGroupId").val(logisticId);
        $("#form-delegate-add").validate({
            focusCleanup: true
        });

        function submitHandler() {
            if ($.validate.form()) {
                $.operate.save(prefix + "/add", $('#form-delegate-add').serialize());
            }
        }

        laydate.render({
			elem: 'input[name=validFrom]',
			format: "dd/MM/yyyy"
		});

      	laydate.render({
			elem: 'input[name=validUntil]',
			format: "dd/MM/yyyy"
		});

        function removeGroupError() {
			$('input[name=delegateCompany]').removeClass('error-input');
		}

		function removeTaxCodeError() {
			$('input[name=delegateTaxcode]').removeClass('error-input');
		}
        function formatValidFlg(value) {
        if (1 == value) {
          return '<span style="color: green">Hiệu lực</span>';
        }
        return '<span style="color: red">Vô hiệu</span>';
        }
        $('#addDelegatedBtn').click(function(event){
            event.preventDefault();
            let errorFlg = false;
            
            if (!$("input[name=delegateTaxcode]").val()) {
                $("input[name=delegateTaxcode]").addClass('error-input');
                errorFlg = true;
                $.modal.alertWarning("Bạn chưa nhập mã số thuế.");
            }
            if (!$("input[name=delegateCompany]").val()) {
                $("input[name=delegateCompany]").addClass('error-input');
                errorFlg = true;
                $.modal.alertWarning("Bạn chưa nhập tên công ty.");
            }
            if (!$("#delegateType option:selected").text() || $("#delegateType option:selected").text() == 'Chọn Loại Ủy Quyền') {
              errorFlg = true;
              $.modal.alertWarning("Bạn chưa chọn loại ủy quyền.");
            }
            if (!$("input[name=validFrom]").val()) {
                $("input[name=validFrom]").addClass('error-input');
                errorFlg = true;
                $.modal.alertWarning("Bạn chưa nhập ngày bắt đầu.");
            }
            if (!$("input[name=validUntil]").val()) {
                $("input[name=validUntil]").addClass('error-input');
                errorFlg = true;
                $.modal.alertWarning("Bạn chưa nhập ngày kết thúc.");
            }
            if (!errorFlg) {
                delegatedLogistic.logisticGroupId = logisticId;
                delegatedLogistic.delegateTaxCode = $("input[name=delegateTaxcode]").val();
                delegatedLogistic.delegateCompany = $("input[name=delegateCompany]").val();
                delegatedLogistic.validFlg = 1;
                delegatedLogistic.delegateType = $("#delegateType option:selected").val();
                console.log("TCL: delegatedLogistic", delegatedLogistic)
                $.ajax({
                    url: prefix + "/add",
                    method: "POST",
                    data: delegatedLogistic,
                    success : function(res) {
                        if(res.code == 0)
                        {
                            $.modal.closeLoading();
                            $.modal.alertSuccess("Thêm Ủy Quyền Thành Công");
                            parent.loadTableByLogisticGroup(logisticId);
                        }else {
                            $.modal.closeLoading();
                            $.modal.alertError(res.msg)
                        }
                    },
                    error : function(res) {
                        $.modal.closeLoading();
                        $.modal.alertError("Có lỗi xảy ra, vui lòng liên hệ admin.")
                    }
                });
                
            }

      }); 

      function loadGroupNameForDelegated() {
        if ($('input[name=delegateTaxcode]').val() != null && $('input[name=delegateTaxcode]').val() != '') {
          $('input[name=delegateTaxcode]').removeClass('error-input');
          $.ajax({
            url: prefix + "/consignee/" + $('input[name=delegateTaxcode]').val(),
            method: "get"
          }).done(function (result) {
            if (result.code == 0) {
              $('input[name=delegateCompany]').val(result.groupName);
              $('input[name=delegateCompany]').removeClass('error-input');
            } else {
              $('input[name=delegateCompany]').val('');
            }
          });
        } else {
          $('input[name=delegateCompany]').val('');
        }
      }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head>
  <th:block th:include="include :: header('Add Delegate')" />
  <th:block th:include="include :: datetimepicker-css" />
</head>

<body class="white-bg">
  <div class="wrapper wrapper-content animated fadeInRight ibox-content">
    <form class="form-horizontal m" id="form-delegate-add">
      <div class="form-group">
        <div class="col-sm-8">
          <input name="logisticGroupId" id="logisticGroupId" class="form-control" type="hidden">
        </div>
      </div>
      <div class="form-group">
        <label class="col-sm-3 control-label is-required">MST Ủy Quyền：</label>
        <div class="col-sm-8">
          <input name="delegateTaxcode" id="delegateTaxcode" class="form-control" required/>
        </div>
      </div>
      <div class="form-group">
        <label class="col-sm-3 control-label is-required">Tên Cty Được Ủy Quyền</label>
        <div class="col-sm-8">
          <input name="delegateCompany" class="form-control" onfocus="removeGroupError()" type="text" readonly required/>
        </div>
      </div>
      <div class="form-group">
        <label class="col-sm-3 control-label">Hiệu lực từ ngày：</label>
        <div class="col-sm-8">
          <div class="input-group date">
            <input class="form-control time-input" id="validFrom" name="validFrom" />
            <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
          </div>
        </div>
      </div>
      <div class="form-group">
        <label class="col-sm-3 control-label">Đến ngày: </label>
        <div class="col-sm-8">
          <div class="input-group date">
            <input class="form-control time-input" id="validUntil" name="validUntil" />
            <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
          </div>
        </div>
      </div>
      <div class="form-group">
        <label class="col-sm-3 control-label">Loại ủy quyền：</label>
        <div class="col-sm-3" style="display: relative;">
          <select class="form-control" id="delegateType">
            <option th:each="delegateType, iterator : ${delegateTypes}" th:value=${delegateType.dictValue}
              th:text=${delegateType.dictLabel}>
            </option>
          </select>
        </div>
      </div>
    </form>
  </div>
  <th:block th:include="include :: footer" />
  <th:block th:include="include :: datetimepicker-js" />
  <script type="text/javascript" th:inline="javascript">
    var logisticId = /*[[${logisticId}]]*/ ;
  </script>
  <script th:inline="javascript">
    var prefix = ctx + "logistic/delegate"
    delegatedLogistic = new Object();
    $("#logisticGroupId").val(logisticId);
    $("#form-delegate-add").validate({
      focusCleanup: true
    });

    function submitHandler() {
      if ($.validate.form()) {
        let errorFlg = false;
        if (!$("#delegateType option:selected").text() || $("#delegateType option:selected").text() ==
          'Chọn Loại Ủy Quyền') {
          errorFlg = true;
          $.modal.alertWarning("Bạn chưa chọn loại ủy quyền.");
        }
        if (!errorFlg) {
          delegatedLogistic.logisticGroupId = logisticId;
          delegatedLogistic.delegateTaxCode = $("input[name=delegateTaxcode]").val();
          delegatedLogistic.delegateCompany = $("input[name=delegateCompany]").val();
          delegatedLogistic.validFlg = 1;
          delegatedLogistic.delegateType = $("#delegateType option:selected").val();
          console.log("TCL: delegatedLogistic", delegatedLogistic)
          $.ajax({
            url: prefix + "/add",
            method: "POST",
            data: delegatedLogistic,
            success: function (res) {
              if (res.code == 0) {
                $.modal.closeLoading();
                $.modal.alertSuccess("Thêm Ủy Quyền Thành Công");
                parent.loadTableByLogisticGroup(logisticId);
              } else {
                $.modal.closeLoading();
                $.modal.alertError(res.msg)
              }
            },
            error: function (res) {
              $.modal.closeLoading();
              $.modal.alertError("Có lỗi xảy ra, vui lòng liên hệ admin.")
            }
          });

        }
      }
    }

    laydate.render({
      elem: '#validFrom',
      format: "dd/MM/yyyy"
    });

      laydate.render({
      elem: '#validUntil',
      format: "dd/MM/yyyy"
    });

    $("input[name=validFrom]").on("inputchange", function () {
        let validFrom = stringToDate($('input[name=validFrom]').val());
        let now = new Date();
        now.setHours(0, 0, 0, 0);
        $("input[name=validFrom]").removeClass('error-input');
        if ($('input[name=validUntil]').val() != '' && stringToDate($('input[name=validUntil]').val()).getTime() < validFrom.getTime()) {
          $.modal.alertError('Bạn không thể chọn từ ngày cao hơn đến ngày.')
          $('input[name=validFrom]').val('');
        } else if (validFrom.getTime() < now.getTime()) {
          $.modal.alertError("Bạn không thể chọn từ ngày trong quá khứ.");
          $('input[name=validFrom]').val('');
        } else {
          delegatedLogistic.validFrom = validFrom;
        }
      });

    function removeGroupError() {
      $('input[name=delegateCompany]').removeClass('error-input');
    }

    function removeTaxCodeError() {
      $('input[name=delegateTaxcode]').removeClass('error-input');
    }

    function formatValidFlg(value) {
      if (1 == value) {
        return '<span style="color: green">Hiệu lực</span>';
      }
      return '<span style="color: red">Vô hiệu</span>';
    }

    $("#delegateTaxcode").change(function() {
        loadGroupNameForDelegated();
    });

    function loadGroupNameForDelegated() {
      if ($('input[name=delegateTaxcode]').val() != null && $('input[name=delegateTaxcode]').val() != '') {
        $.ajax({
          url: prefix + "/consignee/" + $('input[name=delegateTaxcode]').val(),
          method: "get"
        }).done(function (result) {
        console.log("TCL: loadGroupNameForDelegated -> result", result)
          if (result.code == 0) {
            $('input[name=delegateCompany]').val(result.groupName);
            $('input[name=delegateCompany]').removeClass('error-input');
          } else {
            $.modal.alertWarning("Không tìm thấy tên công ty trong hệ thống!")
          }
        });
      } else {
        $('input[name=delegateCompany]').val('');
      }
    }
  </script>
</body>

</html>
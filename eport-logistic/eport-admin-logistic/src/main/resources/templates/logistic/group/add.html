<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head>
    <th:block th:include="include :: header('Add Logistic Group')" />
    <th:block th:include="include :: easyui-css" />
    <style type="text/css">
      .dropdown-menu {
        position: absolute;
        top: 100%;
        left: 0;
        z-index: 1000;
        display: none;
        float: left;
        min-width: 118px;
        padding: 5px 0;
        margin: 2px 0 0;
        font-size: 14px;
        text-align: left;
        list-style: none;
        background-color: #f5f5f5 !important;
        -webkit-background-clip: padding-box;
        background-clip: padding-box;
        border: 1px solid #ccc;
        border: 1px solid rgba(0, 0, 0, 0.15);
        border-radius: 4px;
        -webkit-box-shadow: 0 6px 12px rgba(0, 0, 0, 0.175);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.175);
      }
      .col-lg-1,
      .col-lg-10,
      .col-lg-11,
      .col-lg-12,
      .col-lg-2,
      .col-lg-3,
      .col-lg-4,
      .col-lg-5,
      .col-lg-6,
      .col-lg-7,
      .col-lg-8,
      .col-lg-9,
      .col-md-1,
      .col-md-10,
      .col-md-11,
      .col-md-12,
      .col-md-2,
      .col-md-3,
      .col-md-4,
      .col-md-5,
      .col-md-6,
      .col-md-7,
      .col-md-8,
      .col-md-9,
      .col-sm-1,
      .col-sm-10,
      .col-sm-11,
      .col-sm-12,
      .col-sm-2,
      .col-sm-3,
      .col-sm-4,
      .col-sm-5,
      .col-sm-6,
      .col-sm-7,
      .col-sm-8,
      .col-sm-9,
      .col-xs-1,
      .col-xs-10,
      .col-xs-11,
      .col-xs-12,
      .col-xs-2,
      .col-xs-3,
      .col-xs-4,
      .col-xs-5,
      .col-xs-6,
      .col-xs-7,
      .col-xs-8,
      .col-xs-9 {
        position: relative;
        min-height: 1px;
        padding-right: 1px !important;
        padding-left: 1px !important;
      }
      .row {
        margin-right: 0px !important;
        margin-left: 0px !important;
      }
      .error-input {
        background-color: #fbe2e2;
        border-color: #c66161;
        color: #c00;
      }
    </style>
  </head>
  <body class="white-bg">
    <div class="main-content">
      <div class="col-sm-6">
        <form class="form-horizontal m" id="form-group-add" style="height: calc(100% - 36px);">
          <div class="row">
            <h2>Thông tin công ty</h2>
          </div>
          <div class="row">
            <div class="col-sm-12">
              <div class="form-group">
                <label class="col-sm-3 control-label is-required">MST doanh nghiệp：</label>
                <div class="col-sm-2">
                  <input name="mst" class="form-control" type="text" onfocusout="loadGroupName()" required />
                </div>
                <label class="col-sm-2 control-label">PT Thanh toán：</label>
                <input style="margin-top: 10px;" type="radio" name="creditFlag" value="0" checked />
                <label style="margin-left: 5px;">Cash</label>
                <input style="margin-top: 10px; margin-left: 20px;" type="radio" name="creditFlag" value="1" />
                <label style="margin-left: 5px;">Credit</label>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label class="col-sm-3 control-label is-required">Tên doanh nghiệp：</label>
            <div class="col-sm-8">
              <input name="groupName" class="form-control" type="text" required />
            </div>
          </div>
          <div class="form-group">
            <label class="col-sm-3 control-label is-required">Địa chỉ liên hệ：</label>
            <div class="col-sm-8">
              <input name="address" class="form-control" type="text" required />
            </div>
          </div>
          <div class="row">
            <div class="col-sm-12">
              <div class="form-group">
                <label class="col-sm-3 control-label is-required">Điện thoại di động：</label>
                <div class="col-sm-2" style="display: relative;">
                  <input name="mobilePhone" class="form-control" type="text" required />
                  <span style="position: absolute; right: 10px; top: 30%;" title="Dùng để nhận mã OTP khi đăng ký nâng hạ"><i class="fa fa-question-circle"></i></span>
                </div>
                <label class="col-sm-1 control-label is-required">Email：</label>
                <div class="col-sm-5">
                  <input name="email" class="form-control" type="text" required />
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="col-sm-6">
        <form class="form-horizontal m" id="form-delegate-add" style="height: calc(100% - 36px);">
          <div class="row">
            <h2>Danh sách ủy quyền</h2>
          </div>
          <div class="row">
            <div class="col-sm-12">
              <div class="form-group">
                <label class="col-sm-3 control-label is-required">Mã số thuế：</label>
                <div class="col-sm-2" style="display: relative;">
                  <input name="delegateTaxcode" class="form-control" onfocus="removeTaxCodeError()" onfocusout="loadGroupNameForDelegated()" type="text" />
                </div>
                <label class="col-sm-2 control-label is-required">Tên doanh nghiệp: </label>
                <div class="col-sm-5">
                  <input name="delegateCompany" class="form-control" onfocus="removeGroupError()" type="text" />
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-sm-12">
              <div class="form-group">
                <label class="col-sm-3 control-label is-required">Hiệu lực từ ngày：</label>
                <div class="col-sm-2" style="display: relative;">
                  <input name="validFrom" class="form-control" type="text" readonly />
                </div>
                <label class="col-sm-2 control-label is-required">Đến ngày: </label>
                <div class="col-sm-2">
                  <input name="validUntil" class="form-control" type="text" readonly />
                </div>
                <div class="col-sm-2" style="margin-left: 20px; margin-top: 3px;">
                  <button id="addDelegatedBtn" class="btn btn-sm btn-success">Thêm Ủy Quyền</button>
                </div>
              </div>
            </div>
          </div>  
        </form>
        <div class="row">
          <table id="dg" style="width: 100%;" fitcolumns=true>
            <thead>
              <tr>
                  <th data-options="field:'delegateTaxCode', halign:'center', resizable:true">Mã Số Thuế</th>
                  <th data-options="field:'delegateCompany', align:'center', halign:'center', resizable:true">Tên Công Ty</th>
                  <th data-options="field:'validFlg', align:'center', halign:'center', resizable:true, formatter: formatValidFlg">Trạng Thái</th>
                  <th data-options="field:'validFrom', halign:'center', resizable:true, formatter: formatDate">Từ Ngày</th>
                  <th data-options="field:'validUntil', align:'center', halign:'center', resizable:true, formatter: formatDate">Đến Ngày</th>
                  <th data-options="field:'action', align:'center', halign:'center', resizable:true, fixed:true, formatter: formatAction" width=150>Thao Tác</th>
              </tr>
          </thead>
          <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="col-sm-12 footer">
        <div class="col-sm-offset-5 col-sm-10">
          <button type="button" class="btn btn-sm btn-primary" onclick="submitHandler()"><i class="fa fa-check">Lưu</i></button>&nbsp;
          <button type="button" class="btn btn-sm btn-danger" onclick="closeItem()"><i class="fa fa-reply-all">Quay lại</i></button>
        </div>
      </div>
    </div>
    <th:block th:include="include :: footer" />
    <th:block th:include="include :: easyui-js" />
    <script type="text/javascript">
      var prefix = ctx + "logistic/group";
      var delegatedLogistic = new Object();
      var delegatedLogistics = [];

      $("#form-group-add").validate({
        focusCleanup: true,
      });

      try {
        loadtable();
      } catch (error) {
        // console log 
      }

      function submitHandler() {
        if ($.validate.form()) {
          // $.operate.saveTab(prefix + "/add", $("#form-group-add").serialize());
          let logisticGroup = new Object();
          logisticGroup.mst = $('input[name=mst]').val();
          logisticGroup.creditFlag = $('input[name=creditFlag]').val();
          logisticGroup.groupName = $('input[name=groupName]').val();
          logisticGroup.address = $('input[name=address]').val();
          logisticGroup.mobilePhone = $('input[name=mobilePhone]').val();
          logisticGroup.email = $('input[name=email]').val();
          $.modal.loading("Đang xử lý...");
          $.ajax({
            url: prefix + "/add",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({
              logisticGroup : JSON.stringify(logisticGroup),
              delegatedLogistics : JSON.stringify(delegatedLogistics)
            }),
            success : function(res) {
              $.modal.closeLoading();
              $.operate.successTabCallback(res);
            },
            error : function(res) {
              $.modal.closeLoading();
              $.modal.alertError("Có lỗi xảy ra, vui lòng liên hệ admin.")
            }
          });
        }
      }

      laydate.render({
        elem: 'input[name=validFrom]',
        format: "dd/MM/yyyy"
      });

      laydate.render({
        elem: 'input[name=validUntil]',
        format: "dd/MM/yyyy"
      });

      function loadGroupName() {
        if ($('input[name=mst]').val() != null && $('input[name=mst]').val() != '') {
          $.ajax({
            url: prefix + "/company/" + $('input[name=mst]').val(),
            method: "get"
          }).done(function (result) {
            if (result.code == 0) {
              $('input[name=groupName]').val(result.groupName);
              $('input[name=address]').val(result.address);
            } else {
              $('input[name=groupName]').val('');
              $('input[name=address]').val('');
            }
          });
        } else {
          $('input[name=groupName]').val('');
          $('input[name=address]').val('');
        }
      }

      function loadGroupNameForDelegated() {
        if ($('input[name=delegateTaxcode]').val() != null && $('input[name=delegateTaxcode]').val() != '') {
          $('input[name=delegateTaxcode]').removeClass('error-input');
          $.ajax({
            url: prefix + "/company/" + $('input[name=delegateTaxcode]').val(),
            method: "get"
          }).done(function (result) {
            if (result.code == 0) {
              $('input[name=delegateCompany]').val(result.groupName);
              $('input[name=delegateCompany]').removeClass('error-input');
            } else {
              $('input[name=delegateCompany]').val('');
            }
          });
        } else {
          $('input[name=delegateCompany]').val('');
        }
      }

      function removeGroupError() {
        $('input[name=delegateCompany]').removeClass('error-input');
      }

      function removeTaxCodeError() {
        $('input[name=delegateTaxcode]').removeClass('error-input');
      }

      function formatDate(value) {
        if (value == null) return "";
        var date = new Date(value);
        return formatNumber(date.getDate())
          + "/" + formatNumber(date.getMonth() + 1)
          + "/" + date.getFullYear()
      }

      function formatNumber(number) {
        return number < 10 ? "0" + number : number;
      }

      function formatValidFlg(value) {
        if (1 == value) {
          return '<span style="color: green">Hiệu lực</span>';
        }
        return '<span style="color: red">Vô hiệu</span>';
      }

      function formatAction(value, row, index) {
        let actions = [];
        actions.push('<a class="btn btn-danger btn-xs " onclick="remove(\'' + index + '\')"><i class="fa fa-remove"></i>Xóa</a>');
        return actions.join('');
      }

      function remove(index) {
        delegatedLogistics.splice(index, 1);
        loadtable();
      }

      $.event.special.inputchange = {
        setup: function () {
          var self = this,
            val;
          $.data(
            this,
            "timer",
            window.setInterval(function () {
              val = self.value;
              if ($.data(self, "cache") != val) {
                $.data(self, "cache", val);
                $(self).trigger("inputchange");
              }
            }, 20)
          );
        },
        teardown: function () {
          window.clearInterval($.data(this, "timer"));
        },
        add: function () {
          $.data(this, "cache", this.value);
        },
      };

      $("input[name=validFrom]").on("inputchange", function () {
        let validFrom = stringToDate($('input[name=validFrom]').val());
        let now = new Date();
        now.setHours(0, 0, 0, 0);
        $("input[name=validFrom]").removeClass('error-input');
        if ($('input[name=validUntil]').val() != '' && stringToDate($('input[name=validUntil]').val()).getTime() < validFrom.getTime()) {
          $.modal.alertError('Bạn không thể chọn từ ngày cao hơn đến ngày.')
          $('input[name=validFrom]').val('');
        } else if (validFrom.getTime() < now.getTime()) {
          $.modal.alertError("Bạn không thể chọn từ ngày trong quá khứ.");
          $('input[name=validFrom]').val('');
        } else {
          delegatedLogistic.validFrom = validFrom;
        }
      });

      $("input[name=validUntil]").on("inputchange", function () {
        let validUntil = stringToDate($("input[name=validUntil]").val());
        let now = new Date();
        now.setHours(0, 0, 0, 0);
        $("input[name=validUntil]").removeClass('error-input');
        if ($("input[name=validFrom]").val() != "" && stringToDate($("input[name=validFrom]").val()).getTime() > validUntil.getTime()) {
          $.modal.alertError("Bạn không thể chọn đến ngày thấp hơn từ ngày.");
          $("input[name=validUntil]").val("");
        } else if (validUntil.getTime() < now.getTime()) {
          $.modal.alertError("Bạn không thể chọn đến ngày trong quá khứ.");
          $("input[name=validUntil]").val("");
        } else {
          validUntil.setHours(23, 59, 59);
          delegatedLogistic.validUntil = validUntil;
        }
      });

      function stringToDate(dateStr) {
        let dateParts = dateStr.split('/');
        return new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
      }

      $('#addDelegatedBtn').click(function(event){
        event.preventDefault();
        let errorFlg = false;
        if (!$("input[name=validFrom]").val()) {
          $("input[name=validFrom]").addClass('error-input');
          errorFlg = true;
        }
        if (!$("input[name=validUntil]").val()) {
          $("input[name=validUntil]").addClass('error-input');
          errorFlg = true;
        }
        if (!$("input[name=delegateTaxcode]").val()) {
          $("input[name=delegateTaxcode]").addClass('error-input');
          errorFlg = true;
        }
        if (!$("input[name=delegateCompany]").val()) {
          $("input[name=delegateCompany]").addClass('error-input');
          errorFlg = true;
        }

        if (!errorFlg) {
          delegatedLogistic.delegateTaxCode = $("input[name=delegateTaxcode]").val();
          delegatedLogistic.delegateCompany = $("input[name=delegateCompany]").val();
          delegatedLogistic.validFlg = 1;
          delegatedLogistics.push(delegatedLogistic);
          delegatedLogistic = new Object();
          $("input[name=validFrom]").val('');
          $("input[name=validUntil]").val('');
          $("input[name=delegateTaxcode]").val('');
          $("input[name=delegateCompany]").val('');
          loadtable();
        }

      }); 

      function loadtable() {
        $("#dg").datagrid({
          singleSelect: true,
          height: document.documentElement.clientHeight - 320,
          rownumbers: true,
          nowrap: false,
          striped: true,
          loadMsg: " Đang xử lý...",
          loader: function (param, success, error) {
            success(delegatedLogistics);
          },
        });
      }
    </script>
  </body>
</html>
